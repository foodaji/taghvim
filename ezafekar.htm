<!doctype html>
<html lang="fa" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مدیریت امتیازات و اضافه‌کاری</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Vazirmatn', 'Tahoma', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    * {
      box-sizing: border-box;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 2.5rem;
      width: 100%;
      max-width: 1200px;
    }

    h1 {
      color: #2d3748;
      text-align: center;
      margin: 0 0 1rem 0;
      font-size: 2rem;
      font-weight: bold;
    }

    .month-selector {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .month-display {
      font-size: 1.5rem;
      font-weight: bold;
      color: #667eea;
      min-width: 200px;
      text-align: center;
    }

    .nav-button {
      background: #667eea;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .nav-button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .nav-button:active {
      transform: translateY(0);
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #667eea;
      font-size: 1.2rem;
    }

    .error {
      background: #fed7d7;
      color: #c53030;
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 1rem;
    }

    .table-container {
      overflow-x: auto;
      margin-bottom: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      text-align: center;
      font-weight: bold;
      font-size: 1rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td {
      padding: 0.875rem;
      text-align: center;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.95rem;
    }

    tr:hover {
      background: #f7fafc;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .score-cell {
      font-weight: bold;
      color: #667eea;
      font-size: 1.1rem;
    }

    input[type="number"] {
      width: 100%;
      padding: 0.5rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      text-align: center;
      font-size: 0.95rem;
      transition: border-color 0.3s ease;
      font-family: inherit;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .final-overtime {
      background: #c6f6d5;
      font-weight: bold;
      color: #22543d;
      font-size: 1.05rem;
    }

    .calculate-button {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: none;
      padding: 1rem 2.5rem;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      display: block;
      margin: 0 auto;
      transition: all 0.3s ease;
      font-family: inherit;
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
    }

    .calculate-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
    }

    .calculate-button:active {
      transform: translateY(0);
    }

    .calculate-button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1.5rem;
      }

      h1 {
        font-size: 1.5rem;
      }

      .month-display {
        font-size: 1.2rem;
      }

      th, td {
        padding: 0.5rem;
        font-size: 0.85rem;
      }

      .nav-button {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container"><!-- صفحه ورود -->
   <div id="login-container">
    <h1 style="color: #2d3748; text-align: center; margin-bottom: 2rem;">ورود به سیستم</h1>
    <div style="max-width: 400px; margin: 0 auto;">
     <div style="margin-bottom: 1.5rem;"><label for="password-input" style="display: block; font-weight: bold; color: #2d3748; margin-bottom: 0.5rem;">رمز عبور:</label> <input type="password" id="password-input" style="width: 100%; padding: 1rem; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; font-family: inherit; text-align: center;" placeholder="رمز عبور را وارد کنید">
     </div>
     <div id="login-error" class="error" style="display: none; margin-bottom: 1rem;">
      رمز عبور اشتباه است!
     </div><button id="login-btn" class="calculate-button" style="width: 100%;">ورود</button>
     <div id="login-loading" class="loading" style="display: none; padding: 1rem;">
      در حال بررسی رمز عبور...
     </div>
    </div>
   </div><!-- صفحه اصلی -->
   <div id="main-container" style="display: none;">
    <h1 id="page-title">مدیریت امتیازات و اضافه‌کاری</h1>
    <div class="month-selector"><button class="nav-button" id="prev-month">ماه قبل</button>
     <div class="month-display" id="current-month"></div><button class="nav-button" id="next-month">ماه بعد</button>
    </div>
    <div style="text-align: center; margin-bottom: 2rem;"><label for="max-hours" style="font-weight: bold; color: #2d3748; margin-left: 1rem;">حداکثر ساعت مجاز:</label> <input type="number" id="max-hours" value="120" min="1" step="1" style="padding: 0.5rem; border: 2px solid #667eea; border-radius: 8px; text-align: center; font-size: 1rem; width: 100px; font-family: inherit;">
    </div>
    <div id="error-message" class="error" style="display: none;"></div>
    <div id="loading" class="loading">
     در حال بارگذاری...
    </div>
    <div id="table-container" style="display: none;">
     <div class="table-container">
      <table id="data-table">
       <thead>
        <tr>
         <th>نام همکار</th>
         <th>مجموع امتیاز</th>
         <th>اضافه‌کار فعلی (ساعت)</th>
         <th>اضافه‌کار نهایی (ساعت)</th>
        </tr>
       </thead>
       <tbody id="table-body"></tbody>
      </table>
     </div><button class="calculate-button" id="calculate-btn">محاسبه اضافه‌کار نهایی</button>
    </div>
   </div>
  </div>
  <script>
    const API_URL = "https://api.jsonbin.io/v3/b/6843ffef8a456b7966aa6e9e";
    const API_KEY = "$2a$10$K0GxG/YDDvwcCOicoQSc3OIPqPpUflP5JvKxVStM6sdQYjq4LdXKi";

    const persianMonths = [
      'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور',
      'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'
    ];

    let currentJalaliYear, currentJalaliMonth;
    let ratingsData = [];
    let memberData = {};
    let appPassword = '';
    let isAuthenticated = false;

    async function checkAuthentication() {
      try {
        const response = await fetch(API_URL, {
          headers: {
            'X-Master-Key': API_KEY
          }
        });
        
        if (!response.ok) {
          throw new Error('خطا در دریافت اطلاعات');
        }
        
        const data = await response.json();
        appPassword = data.record.appPassword || '';
        
        // همیشه صفحه ورود را نمایش دهیم - هیچ ذخیره‌سازی خودکار نداریم
        // کاربر باید هر بار رمز عبور را وارد کند
      } catch (error) {
        console.error('خطا در بررسی احراز هویت:', error);
      }
    }

    function showMainContainer() {
      document.getElementById('login-container').style.display = 'none';
      document.getElementById('main-container').style.display = 'block';
      
      const previousMonth = getPreviousJalaliMonth();
      currentJalaliYear = previousMonth.year;
      currentJalaliMonth = previousMonth.month;
      updateMonthDisplay();
      fetchData();
    }

    function handleLogin() {
      const passwordInput = document.getElementById('password-input');
      const enteredPassword = passwordInput.value.trim();
      const loginError = document.getElementById('login-error');
      const loginLoading = document.getElementById('login-loading');
      const loginBtn = document.getElementById('login-btn');
      
      if (!enteredPassword) {
        loginError.textContent = 'لطفاً رمز عبور را وارد کنید';
        loginError.style.display = 'block';
        return;
      }
      
      loginLoading.style.display = 'block';
      loginBtn.disabled = true;
      loginError.style.display = 'none';
      
      setTimeout(() => {
        if (enteredPassword === appPassword) {
          isAuthenticated = true;
          showMainContainer();
        } else {
          loginError.textContent = 'رمز عبور اشتباه است!';
          loginError.style.display = 'block';
        }
        
        loginLoading.style.display = 'none';
        loginBtn.disabled = false;
        passwordInput.value = '';
      }, 1000);
    }

    function gregorianToJalali(gYear, gMonth, gDay) {
      const g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
      let jy = (gYear <= 1600) ? 0 : 979;
      gYear -= (gYear <= 1600) ? 621 : 1600;
      let gy2 = (gMonth > 2) ? (gYear + 1) : gYear;
      let days = (365 * gYear) + (Math.floor((gy2 + 3) / 4)) - (Math.floor((gy2 + 99) / 100)) + 
                 (Math.floor((gy2 + 399) / 400)) - 80 + gDay + g_d_m[gMonth - 1];
      jy += 33 * Math.floor(days / 12053);
      days %= 12053;
      jy += 4 * Math.floor(days / 1461);
      days %= 1461;
      if (days > 365) {
        jy += Math.floor((days - 1) / 365);
        days = (days - 1) % 365;
      }
      const jm = (days < 186) ? 1 + Math.floor(days / 31) : 7 + Math.floor((days - 186) / 30);
      const jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
      return { year: jy, month: jm, day: jd };
    }

    function getPreviousJalaliMonth() {
      const now = new Date();
      const jalali = gregorianToJalali(now.getFullYear(), now.getMonth() + 1, now.getDate());
      let year = jalali.year;
      let month = jalali.month - 1;
      if (month < 1) {
        month = 12;
        year--;
      }
      return { year, month };
    }

    async function fetchData() {
      try {
        const response = await fetch(API_URL, {
          headers: {
            'X-Master-Key': API_KEY
          }
        });
        
        if (!response.ok) {
          throw new Error('خطا در دریافت اطلاعات');
        }
        
        const data = await response.json();
        ratingsData = data.record.ratings || [];
        processData();
      } catch (error) {
        showError('خطا در بارگذاری داده‌ها: ' + error.message);
      }
    }

    function processData() {
      memberData = {};
      
      ratingsData.forEach(rating => {
        const dateParts = rating.date.split('-');
        const jalali = gregorianToJalali(
          parseInt(dateParts[0]),
          parseInt(dateParts[1]),
          parseInt(dateParts[2])
        );
        
        if (jalali.year === currentJalaliYear && jalali.month === currentJalaliMonth) {
          if (!memberData[rating.member]) {
            memberData[rating.member] = {
              totalScore: 0,
              currentOvertime: 0,
              finalOvertime: 0
            };
          }
          memberData[rating.member].totalScore += rating.score || 0;
        }
      });
      
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';
      
      const members = Object.keys(memberData).sort();
      
      if (members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: #718096;">داده‌ای برای این ماه یافت نشد</td></tr>';
        document.getElementById('loading').style.display = 'none';
        document.getElementById('table-container').style.display = 'block';
        return;
      }
      
      members.forEach(member => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="font-weight: bold;">${member}</td>
          <td class="score-cell">${memberData[member].totalScore}</td>
          <td>
            <input type="number" 
                   min="0" 
                   step="0.5" 
                   placeholder="0"
                   data-member="${member}"
                   class="overtime-input">
          </td>
          <td class="final-overtime" data-member="${member}">-</td>
        `;
        tbody.appendChild(row);
      });
      
      document.querySelectorAll('.overtime-input').forEach(input => {
        input.addEventListener('input', (e) => {
          const member = e.target.dataset.member;
          memberData[member].currentOvertime = parseFloat(e.target.value) || 0;
        });
      });
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('table-container').style.display = 'block';
    }

    function calculateFinalOvertime() {
      const members = Object.keys(memberData);
      if (members.length === 0) return;
      
      // دریافت حداکثر ساعت مجاز از فیلد ورودی
      const maxHours = parseFloat(document.getElementById('max-hours').value) || 120;
      
      // مرتب کردن اعضا بر اساس امتیاز (از بالا به پایین)
      const sortedMembers = members.sort((a, b) => memberData[b].totalScore - memberData[a].totalScore);
      
      // فیلتر کردن افرادی که اضافه‌کار خام آنها کمتر از حداکثر مجاز است
      const eligibleMembers = sortedMembers.filter(member => memberData[member].currentOvertime < maxHours);
      
      if (eligibleMembers.length === 0) {
        // اگر همه بالای حداکثر مجاز هستند، همان مقادیر خام را نمایش دهیم
        members.forEach(member => {
          memberData[member].finalOvertime = memberData[member].currentOvertime;
          const cell = document.querySelector(`td.final-overtime[data-member="${member}"]`);
          if (cell) cell.textContent = memberData[member].finalOvertime.toFixed(2);
        });
        return;
      }
      
      let foundValidSolution = false;
      
      // تلاش با هر یک از اعضا واجد شرایط به ترتیب امتیاز
      for (let i = 0; i < eligibleMembers.length && !foundValidSolution; i++) {
        const referenceMember = eligibleMembers[i];
        const referenceScore = memberData[referenceMember].totalScore;
        const referenceOvertime = memberData[referenceMember].currentOvertime;
        
        // محاسبه A
        const A = referenceScore / (maxHours - referenceOvertime);
        
        if (A <= 0) continue; // اگر A منفی یا صفر باشد، به نفر بعدی برویم
        
        let allValid = true;
        const tempResults = {};
        
        // محاسبه اضافه‌کار نهایی برای همه
        eligibleMembers.forEach(member => {
          const score = memberData[member].totalScore;
          const currentOT = memberData[member].currentOvertime;
          const finalOT = currentOT + (score / A);
          
          tempResults[member] = finalOT;
          
          // بررسی اینکه آیا نتیجه از حداکثر مجاز تجاوز می‌کند
          if (finalOT > maxHours) {
            allValid = false;
          }
        });
        
        // اگر همه نتایج معتبر بودند، آنها را اعمال کنیم
        if (allValid) {
          foundValidSolution = true;
          
          // اعمال نتایج برای اعضای واجد شرایط
          eligibleMembers.forEach(member => {
            memberData[member].finalOvertime = Math.round(tempResults[member] * 100) / 100;
          });
          
          // برای افرادی که اضافه‌کار خام آنها از حداکثر مجاز بیشتر یا مساوی است، همان مقدار خام را نگه داریم
          members.forEach(member => {
            if (memberData[member].currentOvertime >= maxHours) {
              memberData[member].finalOvertime = memberData[member].currentOvertime;
            }
          });
        }
      }
      
      // اگر هیچ راه‌حل معتبری پیدا نشد، مقادیر خام را نمایش دهیم
      if (!foundValidSolution) {
        members.forEach(member => {
          memberData[member].finalOvertime = memberData[member].currentOvertime;
        });
      }
      
      // نمایش نتایج در جدول
      members.forEach(member => {
        const cell = document.querySelector(`td.final-overtime[data-member="${member}"]`);
        if (cell) {
          cell.textContent = memberData[member].finalOvertime.toFixed(2);
        }
      });
    }

    function updateMonthDisplay() {
      const monthName = persianMonths[currentJalaliMonth - 1];
      document.getElementById('current-month').textContent = `${monthName} ${currentJalaliYear}`;
    }

    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    }

    function changeMonth(delta) {
      currentJalaliMonth += delta;
      if (currentJalaliMonth > 12) {
        currentJalaliMonth = 1;
        currentJalaliYear++;
      } else if (currentJalaliMonth < 1) {
        currentJalaliMonth = 12;
        currentJalaliYear--;
      }
      updateMonthDisplay();
      processData();
    }

    document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
    document.getElementById('next-month').addEventListener('click', () => changeMonth(1));
    document.getElementById('calculate-btn').addEventListener('click', calculateFinalOvertime);
    
    // Event listeners برای صفحه ورود
    document.getElementById('login-btn').addEventListener('click', handleLogin);
    document.getElementById('password-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleLogin();
      }
    });

    const defaultConfig = {
      page_title: "مدیریت امتیازات و اضافه‌کاری",
      calculate_button_text: "محاسبه اضافه‌کار نهایی"
    };

    async function onConfigChange(config) {
      document.getElementById('page-title').textContent = config.page_title || defaultConfig.page_title;
      document.getElementById('calculate-btn').textContent = config.calculate_button_text || defaultConfig.calculate_button_text;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ["page_title", config.page_title || defaultConfig.page_title],
          ["calculate_button_text", config.calculate_button_text || defaultConfig.calculate_button_text]
        ])
      });
    }

    // شروع برنامه با بررسی احراز هویت
    checkAuthentication();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99a22a35016c9c0c',t:'MTc2MjQwNjY2OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>