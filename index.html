<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سررسید دیجیتال</title>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" type="image/x-icon" href="favicon.ico">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <style>
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #22c55e;
            --success-hover: #16a34a;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --warning: #f59e0b;
            --warning-hover: #d97706;
            --secondary: #6b7280;
            --secondary-hover: #4b5563;
            --light: #f9fafb;
            --dark: #111827;
            
            /* رنگ‌های همکاران */
            --user9: #f97316;  /* نارنجی */
            --user9-hover: #ea580c;
            --user2: #22c55e;  /* سبز */
            --user2-hover: #16a34a;
            --user3: #3b82f6;  /* آبی */
            --user3-hover: #2563eb;
            --user4: #8b5cf6;  /* بنفش */
            --user4-hover: #7c3aed;
            --user5: #ec4899;  /* صورتی */
            --user5-hover: #db2777;
            --user6: #14b8a6;  /* فیروزه‌ای */
            --user6-hover: #0d9488;
            --user7: #f43f5e;  /* قرمز */
            --user7-hover: #e11d48;
            --user8: #10b981;  /* سبز */
            --user8-hover: #059669;
            --user1: #f59e0b;  /* زرد */
            --user1-hover: #d97706;
            --user10: #64748b; /* خاکستری */
            --user10-hover: #475569;
            --user11: #06b6d4; /* آبی فیروزه‌ای */
            --user11-hover: #0891b2;
            --user12: #a855f7; /* بنفش */
            --user12-hover: #9333ea;
        }
        
        body { 
            font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f7fafc;
        }
        
        .container { 
            max-width: 1280px; 
            margin-left: auto; 
            margin-right: auto; 
            padding: 1rem;
        }

/* استایل برای دکمه‌های حرکت بین روزها */
.rating-day-nav-btn {
    padding: 0.5rem 1rem;
    background-color: var(--secondary);
    color: white;
    border-radius: 0.25rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.rating-day-nav-btn:hover {
    background-color: var(--secondary-hover);
}

.rating-day-nav-btn i {
    font-size: 0.8rem;
}

.mission-item {
    position: relative;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    transition: all 0.2s;
}

.mission-item:hover {
    background-color: #f9fafb;
}

.mission-actions {
    display: none;
    margin-right: auto;
    gap: 0.25rem;
}

/* .mission-item:hover .mission-actions {
    display: none;
} */


.mission-actions.show-actions {
      display: flex;
}

.mission-actions-toggle {
    cursor: pointer;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
    margin-left: 0.5rem;
}


.mission-actions button {
    margin: 0.25rem 0;
    text-align: right;
    justify-content: flex-end;
}

.mission-actions-toggle:hover {
    background-color: #f3f4f6;
}
.completed-mission {
    background-color: #f0fdf4;
    border-color: #bbf7d0;
}

.mission-actions button {
    margin: 0.25rem 0;
    text-align: right;
    justify-content: flex-end;
}

.toggle-missions{
     display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background-color: var(--light);
            border-radius: 0.25rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
}

.toggle-equipment {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background-color: var(--light);
    border-radius: 0.25rem;
    cursor: pointer;
    margin-bottom: 0.5rem;
}

.toggle-equipment i {
    transition: transform 0.2s;
}

.toggle-equipment.active i {
    transform: rotate(180deg);
}
        
.group-header {
    background-color: #f3f4f6;
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-weight: bold;
    border-right: 3px solid var(--primary);
}
        .bg-white { 
            background-color: #fff; 
        }
        
        .p-4 { padding: 1rem; }
        .p-2 { padding: 0.5rem; }
        .p-1 { padding: 0.25rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .px-1\.5 { padding-left: 0.375rem; padding-right: 0.375rem; }
        .py-0\.5 { padding-top: 0.125rem; padding-bottom: 0.125rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .mx-1 { margin-left: 0.25rem; margin-right: 0.25rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mr-2 { margin-right: 0.5rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-md { font-size: 1rem; line-height: 1.5rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .font-bold { font-weight: 700; }
        .text-center { text-align: center; }
        .text-white { color: #fff; }
        .text-green-500 { color: var(--success); }
        .text-gray-500 { color: var(--secondary); }
        .text-yellow-500 { color: var(--warning); }
        .text-orange-500 { color: #f97316; }
        .text-red-500 { color: var(--danger); }
        .text-black { color: var(--dark); }
        .bg-blue-500 { background-color: var(--primary); }
        .bg-green-500 { background-color: var(--success); }
        .bg-orange-500 { background-color: #f97316; }
        .bg-gray-50 { background-color: var(--light); }
        .bg-gray-200 { background-color: #e5e7eb; }
        .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
        .hover\:bg-gray-200:hover { background-color: #e5e7eb; }
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-7 { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .gap-4 { gap: 1rem; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .inline-flex { display: inline-flex; }
        .w-full { width: 100%; }
        .w-20 { width: 5rem; }
        .w-1\/2 { width: 50%; }
        .w-6 { width: 1.5rem; }
        .h-6 { height: 1.5rem; }
        .rounded { border-radius: 0.25rem; }
        .rounded-full { border-radius: 9999px; }
        .rounded-lg { border-radius: 0.5rem; }
        .border { border-width: 1px; border-color: #e5e7eb; }
        .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .cursor-pointer { cursor: pointer; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .top-0 { top: 0; }
        .right-0 { right: 0; }
        .hidden { display: none; }
        .line-through { text-decoration: line-through; }
        
        /* Custom Styles */


.goToToday {
    margin-top: 1rem;
    padding: 0.5rem;
    background-color: var(--secondary);
    color: white;
    border-radius: 0.25rem;
    transition: all 0.2s;
}

.goToToday:hover {
    background-color: var(--secondary-hover);
}



        .calendar-day { 
            padding: 0.5rem; 
            cursor: pointer; 
            position: relative; 
            text-align: center;
            transition: all 0.2s;
        }
        .calendar-day:hover { 
            background-color: #f3f4f6; 
        }
        .selected-day { 
            background-color: var(--primary); 
            color: white;
            border-radius: 0.25rem;
        }
        .task-item { 
            display: flex; 
            align-items: center; 
            padding: 0.5rem; 
            margin-bottom: 0.5rem; 
            background-color: var(--light); 
            border-radius: 0.25rem;
            transition: all 0.2s;
        }
        .task-item:hover {
            background-color: #e5e7eb;
        }
        .task-count-badge { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            width: 1.25rem; 
            height: 1.25rem; 
            margin-left: 0.25rem; 
            font-size: 0.75rem; 
            font-weight: 700; 
            color: white; 
            background-color: #f97316; 
            border-radius: 9999px; 
        }
        .holiday { 
            color: var(--danger); 
            font-weight: bold;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            outline: none;
            font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        .btn-success:hover {
            background-color: var(--success-hover);
        }
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        .btn-danger:hover {
            background-color: var(--danger-hover);
        }
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        .btn-warning:hover {
            background-color: var(--warning-hover);
        }
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        .btn-secondary:hover {
            background-color: var(--secondary-hover);
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .btn-icon {
            width: 2rem;
            height: 2rem;
            padding: 0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Task Actions */
        .task-actions {
            display: flex;
            margin-right: auto;
            gap: 0.25rem;
            display: none;
        }
        .task-actions.show-actions {
            display: flex;
        }
        .task-text {
            flex: 1;
            margin-right: 0.5rem;
        }
        .task-description {
            background-color: rgba(255,255,255,0.95);
            color: #111827;
            font-size: 0.85rem;
            margin-top: 0.25rem;
            padding: 0.35rem 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid rgba(0,0,0,0.06);
            box-shadow: 0 1px 0 rgba(0,0,0,0.03) inset;
            margin-right: 0.25rem;
            white-space: pre-wrap;
        }
        .description-input {
            width: 100%;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
            font-family: inherit;
        }
        
        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 250px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 1s ease;
            z-index: 1001;
            padding: 1.5rem;
            overflow-y: auto;
        }
        .settings-panel.open {
            right: 0;
        }
        .holiday-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background-color: var(--light);
            border-radius: 0.25rem;
        }
        .holiday-date {
            flex: 1;
            margin-right: 0.5rem;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            display: none;
        }

@media (max-width: 640px) {
    table {
        font-size: 0.8rem;
    }
    table th, table td {
        padding: 0.25rem;
    }
}
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        /* Calendar Picker */
        .calendar-picker {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        .calendar-picker .calendar-day {
            padding: 0.25rem;
        }
        .calendar-picker .selected-holiday {
            background-color: var(--danger);
            color: white;
            border-radius: 0.25rem;
        }
        
        /* Task Stats */
        .task-stats {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background-color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex;
            gap: 1.5rem;
            z-index: 100;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .stat-value {
            font-weight: bold;
            font-size: 1.25rem;
        }
        .stat-label {
            font-size: 0.75rem;
            color: var(--secondary);
        }
        .completed-stat .stat-value {
            color: var(--success);
        }
        .incomplete-stat .stat-value {
            color: var(--danger);
        }
        
        /* User Colors */
        .user1-bg {
            background-color: var(--user1);
            color: white;
        }
        .user2-bg {
            background-color: var(--user2);
            color: white;
        }
        .user3-bg {
            background-color: var(--user3);
            color: white;
        }
        .user4-bg {
            background-color: var(--user4);
            color: white;
        }
        .user5-bg {
            background-color: var(--user5);
            color: white;
        }
        .user6-bg {
            background-color: var(--user6);
            color: white;
        }
        .user7-bg {
            background-color: var(--user7);
            color: white;
        }
        .user8-bg {
            background-color: var(--user8);
            color: white;
        }
        .user9-bg {
            background-color: var(--user9);
            color: white;
        }
        .user10-bg {
            background-color: var(--user10);
            color: white;
        }
        .user11-bg {
            background-color: var(--user11);
            color: white;
        }
        .user12-bg {
            background-color: var(--user12);
            color: white;
        }
        
        /* Shift Styles */
        .shift-name {
            font-size: 0.6rem;
            margin-top: 0.2rem;
            color: var(--primary);
            font-weight: bold;
        }
        
        /* Multiselect Styles */
        .multiselect {
            width: 100%;
            position: relative;
            margin-top: 0.5rem;
        }
        .select-box {
            position: relative;
        }
        .select-box select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #e5e7eb;
            font-family: inherit;
        }
        .over-select {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
        }
        #checkboxes {
            display: none;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
            background: white;
            position: absolute;
            width: 100%;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
        }
        #checkboxes label {
            display: block;
            padding: 0.5rem;
        }
        #checkboxes label:hover {
            background-color: #f3f4f6;
        }
        
/* استایل برای فیلدهای توضیحات امتیازدهی */
#ratingList input[type="text"] {
    direction: rtl;
    text-align: right;
    font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* استایل برای لیست توضیحات در جدول */
#ratingsStats ul {
    list-style-type: disc;
    padding-right: 1.5rem;
    margin: 0;
}

#ratingsStats li {
    margin-bottom: 0.25rem;
    word-break: break-word;
}


        /* Assignee Modal */
        #assigneeModal .modal-content {
            max-width: 300px;
        }
        .assignee-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        .assignee-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* Note Styles */
        .note-container {
            margin-top: 1rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
        }
        .note-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
            font-family: inherit;
            margin-bottom: 0.5rem;
        }
        .note-content {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            white-space: pre-wrap;
        }
        
        /* Search Options */
        .search-options {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .search-option {
            padding: 0.5rem 1rem;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        .search-option.active {
            background-color: var(--primary);
            color: white;
        }
        
        /* Settings Sections */
        .settings-section {
            margin-bottom: 1rem;
        }
        .settings-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background-color: var(--light);
            border-radius: 0.25rem;
            cursor: pointer;
        }
        .settings-section-header i {
            transition: transform 0.2s;
        }
        .settings-section-header.active i {
            transform: rotate(90deg);
        }
        .settings-section-content {
            padding: 0.75rem;
            background-color: white;
            border-radius: 0 0 0.25rem 0.25rem;
            display: none;
        }
        .settings-section-content.active {
            display: block;
        }
        
        /* Toggle Incomplete Tasks */
        .toggle-incomplete-tasks {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background-color: var(--light);
            border-radius: 0.25rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }
        .toggle-incomplete-tasks i {
            transition: transform 0.2s;
        }
        .toggle-incomplete-tasks.active i {
            transform: rotate(180deg);
        }
        
        /* Toggle Assignee Tasks */
        .toggle-assignee-tasks {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background-color: var(--light);
            border-radius: 0.25rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }
        .toggle-assignee-tasks i {
            transition: transform 0.2s;
        }
        .toggle-assignee-tasks.active i {
            transform: rotate(180deg);
        }
        
        /* Priority Stars */
        .priority-stars {
            display: flex;
            gap: 0.2rem;
            margin-left: 0.5rem;
        }
        .priority-star {
            color: #e5e7eb;
            cursor: pointer;
        }
        .priority-star.active {
            color: #f59e0b;
        }
        
        /* Action Toggle */
        .action-toggle {
            cursor: pointer;
            padding: 0.25rem;
            margin-right: 0.5rem;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: flex-end;
        }
        .notification.success {
            background-color: var(--success);
        }
        .notification.error {
            background-color: var(--danger);
        }
        .notification-content {
            width: 100%;
        }
        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }
        
        /* Password Modal */
        #passwordModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .password-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .password-input {
            width: 100%;
            padding: 0.75rem;
            margin: 1rem 0;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
            font-family: inherit;
        }
        
        /* Equipment Styles */
        .equipment-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: var(--light);
            border-radius: 0.25rem;
            transition: all 0.2s;
        }
        .equipment-item:hover {
            background-color: #e5e7eb;
        }
        .equipment-actions {
            display: flex;
            margin-right: auto;
            gap: 0.25rem;
            display: none;
        }
        .equipment-actions.show-actions {
            display: flex;
        }
        
        /* Backup Section */
        .backup-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .backup-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .backup-path {
            font-size: 0.8rem;
            color: var(--secondary);
            margin-bottom: 0.5rem;
            word-break: break-all;
        }
        .backup-status {
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
        .backup-success {
            color: var(--success);
        }
        .backup-error {
            color: var(--danger);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .grid-cols-1 {
                grid-template-columns: 1fr;
            }
            .settings-panel {
                width: 280px;
            }
            .task-stats {
                left: 50%;
                transform: translateX(-50%);
                bottom: 0.5rem;
                padding: 0.5rem 1rem;
            }
        }
        @media (min-width: 1024px) {
            .lg\:grid-cols-3 { 
                grid-template-columns: repeat(3, minmax(0, 1fr)); 
            }
        }
    </style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Password Modal -->
    <div id="passwordModal">
        <div class="password-content">
            <h2 class="text-xl font-bold mb-4">ورود به سررسید دیجیتال</h2>
            <input type="password" id="passwordInput" class="password-input" placeholder="رمز عبور">
            <button id="loginBtn" class="btn btn-primary w-full">
                <i class="fas fa-sign-in-alt mr-1"></i> ورود
            </button>
            <div id="passwordError" class="text-red-500 text-sm mt-2 hidden">رمز عبور اشتباه است</div>
        </div>
    </div>

    <div class="loading-spinner" id="loadingSpinner"></div>
    <div class="notification" id="notification">
        <button class="notification-close" onclick="closeNotification()">
            <i class="fas fa-times"></i>
        </button>
        <div class="notification-content" id="notificationContent"></div>
    </div>
    
    <div class="container mx-auto" id="mainContent" style="display: none;">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-center">سررسید دیجیتال</h1>
            <div class="flex gap-2">
                <button id="searchToggle" class="btn btn-secondary search-toggle">
                    <i class="fas fa-search mr-1"></i> جستجو
                </button>
                <button id="ratingToggle" class="btn btn-secondary"><i class="fas fa-star mr-1"></i> SCORE</button>
        <button id="settingsToggle" class="btn btn-secondary">
                    <i class="fas fa-cog mr-1"></i> تنظیمات
                </button>
            </div>
        </div>
        
        
<!-- Rating UI Section (inserted) -->
<div id="ratingSection" class="section hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
  <div class="bg-white rounded-lg p-4 md:p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-bold">امتیازدهی به همکاران</h2>
      <div class="flex gap-1 items-center">
        <button id="closeRatingSection" class="btn btn-danger btn-sm" title="بستن">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

<div class="mb-4">
    <label for="ratingDate" class="block mb-1">انتخاب تاریخ (برای ذخیره: میلادی)</label>
    <input type="hidden" id="ratingDate">
    <div id="selectedDateLabel" class="mt-1 text-sm text-gray-600"></div>
    <div class="mt-2" id="ratingPersianCalendarContainer">
     <!-- اضافه کردن دکمه‌های حرکت به روزهای قبل و بعد -->
     <div class="flex justify-between items-center mb-2">
        <button id="prevRatingDay" class="btn btn-secondary">
            <i class="fas fa-chevron-right ml-1"></i> روز قبل
        </button>
        <button id="nextRatingDay" class="btn btn-secondary">
            روز بعد <i class="fas fa-chevron-left mr-1"></i>
        </button>
    </div>
      <div id="ratingPersianCalendar" class="grid grid-cols-7 gap-1 text-center bg-gray-50 p-2 rounded"></div>
      <div class="text-xs text-gray-500 mt-1">روزهای دارای امتیاز با رنگ سبز مشخص شده‌اند؛ برای انتخاب روز کلیک کنید.</div>
    </div>
</div>
   <div id="ratingList" class="mb-4 overflow-x-auto"></div>

    <div class="flex flex-col sm:flex-row gap-2 mb-4">
      <button id="saveAllRatings" class="btn btn-success flex-1">
        <i class="fas fa-save mr-1"></i> ثبت یک‌جای امتیازها
      </button>
      <button id="showMonthlyAverages" class="btn btn-secondary flex-1">
        <i class="fas fa-chart-bar mr-1"></i> نمایش آمار ماهانه
      </button>
    </div>

    <canvas id="ratingChart" class="hidden w-full" style="height:260px;"></canvas>
    
    <div class="flex flex-col sm:flex-row justify-center gap-2 mt-4">
      <button id="prevRatingMonth" class="btn btn-primary" title="ماه قبل">
        <i class="fas fa-chevron-right mr-1"></i> ماه قبل
      </button>
      <button id="nextRatingMonth" class="btn btn-primary" title="ماه بعد">
        ماه بعد <i class="fas fa-chevron-left ml-1"></i>
      </button>
    </div>
    
    <div id="ratingMonthYear" class="mt-2 text-sm text-gray-600 text-center"></div>
    <div id="ratingsStats" class="mt-2 text-sm overflow-x-auto"></div>
  </div>
</div>
<!-- End Rating UI Section -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
<!-- تقویم -->
<div class="bg-white p-4 rounded-lg shadow">
    <div class="flex justify-between items-center mb-4">
        <button id="prevMonth" class="btn btn-primary">
            <i class="fas fa-chevron-right mr-1"></i> ماه قبل
        </button>
        <h2 id="monthYear" class="text-lg font-bold"></h2>
        <button id="nextMonth" class="btn btn-primary">
            ماه بعد <i class="fas fa-chevron-left ml-1"></i>
        </button>
    </div>
    <div id="calendar" class="grid grid-cols-7 gap-1 text-center"></div>
    
    <!-- دکمه برو به امروز -->
  <button id="goToToday" class="btn btn-danger w-full mt-4">
    <i class="fas fa-calendar-day mr-1"></i> برو به امروز
</button>

                
                <!-- یادداشت روز -->
                <div class="note-container">
                    <h3 class="text-lg font-bold mb-2">یادداشت روز</h3>
                    <textarea id="noteInput" class="note-textarea" placeholder="یادداشت خود را اینجا بنویسید..."></textarea>
                    <button id="saveNote" class="btn btn-primary">
                        <i class="fas fa-save mr-1"></i> ذخیره یادداشت
                    </button>
                    <div id="noteContent" class="note-content hidden"></div>
                </div>
            </div>

            <!-- مدیریت کارها -->

            <div class="bg-white p-4 rounded-lg shadow">
                <h2 id="selectedDate" class="text-lg font-bold mb-4"></h2>


<div class="flex flex-row gap-2 mb-4 items-center justify-start">
    <button id="sortByAssignee" class="btn btn-primary btn-sm whitespace-nowrap min-w-[150px]">
        <i class="fas fa-users ml-1"></i>
        <span>مرتب‌سازی بر اساس همکار</span>
    </button>
    <button id="sortByPriority" class="btn btn-primary btn-sm whitespace-nowrap min-w-[150px]">
        <i class="fas fa-star ml-1"></i>
        <span>مرتب‌سازی بر اساس اهمیت</span>
    </button>
    <button id="toggleCompletedTasks" class="btn btn-secondary btn-sm whitespace-nowrap min-w-[180px]">
        <i class="fas fa-eye-slash ml-1"></i>
        <span>نمایش کارهای انجام شده</span>
    </button>
</div>


                <div class="mb-4">
                    <input id="taskInput" type="text" placeholder="کار جدید..." class="w-full p-2 border rounded">
                    <div class="mt-2">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="isRecurring" class="mr-2">
                            <span>کار تکراری</span>
                        </label>
                        <div id="recurringOptions" class="hidden mt-2">
                            <select id="recurringType" class="p-2 border rounded">
                                <option value="weekly">هفتگی</option>
                                <option value="daily">هر X روز</option>
                                <option value="monthly">ماهیانه</option>
                            </select>
                            <input id="recurringInterval" type="number" min="1" value="1" class="p-2 border rounded w-20" placeholder="فاصله">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label>اولویت:</label>
                        <div class="priority-stars" id="priorityStars">
                            <i class="fas fa-star priority-star" data-value="3"></i>
                            <i class="fas fa-star priority-star" data-value="2"></i>
                            <i class="fas fa-star priority-star" data-value="1"></i>
                        </div>
                        <input type="hidden" id="taskPriority" value="0">
                    </div>
                    <div class="multiselect">
                        <div class="select-box">
                            <select id="assigneeSelect" multiple class="hidden">
                                <!-- Options will be added dynamically -->
                            </select>
                            <div class="over-select"></div>
                        </div>
                        <div id="checkboxes">
                            <!-- Checkboxes will be added dynamically -->
                        </div>
                    </div>
                    <button id="addTask" class="btn btn-success mt-2 w-full">
                        <i class="fas fa-plus mr-1"></i> افزودن
                    </button>
                </div>
                <div id="taskList" class="mt-4"></div>
            </div>






            <!-- کارهای انجام‌نشده، لوازم مورد نیاز و جستجو -->






            <div>

    <!-- جستجو -->
                <div id="searchSection" class="bg-white p-4 rounded-lg shadow hidden">
                    <h2 class="text-lg font-bold mb-4">جستجو</h2>
                    <div class="search-options">
                        <div class="search-option active" data-type="tasks">کارها</div>
                        <div class="search-option" data-type="notes">یادداشتها</div>
                    </div>
                    <div class="mb-4">
                        <input id="searchInput" type="text" placeholder="جستجوی کار یا توضیحات..." class="w-full p-2 border rounded mb-2">
                        <div class="flex gap-2">
                            <input id="searchStartDate" type="text" placeholder="از تاریخ (YYYY-MM-DD)" class="p-2 border rounded w-1/2">
                            <input id="searchEndDate" type="text" placeholder="تا تاریخ (YYYY-MM-DD)" class="p-2 border rounded w-1/2">
                        </div>
                    </div>
                    <div id="searchResults" class="mt-4"></div>
                </div>

    
                <!-- کارهای انجام‌نشده -->
                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <div class="toggle-incomplete-tasks" id="toggleIncompleteTasks">
                        <h2 class="text-lg font-bold">کارهای انجام‌نشده</h2>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div id="incompleteTasks" class="mt-2 hidden"></div>
                </div>
                
                <!-- کارهای اختصاص داده شده به همکاران -->
                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <div class="toggle-assignee-tasks" id="toggleAssigneeTasks">
                        <h2 class="text-lg font-bold">کارهای اختصاص داده شده</h2>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div id="assigneeTasksSection" class="mt-2 hidden">
                        <select id="assigneeFilter" class="w-full p-2 border rounded mb-2">
                            <option value="">همه همکاران</option>
                            <!-- Options will be added dynamically -->
                        </select>
                        <div id="assigneeTasks" class="mt-2"></div>
                    </div>
                </div>
                
             <!-- لوازم مورد نیاز -->
<div class="bg-white p-4 rounded-lg shadow mb-4">
    <div class="toggle-equipment" id="toggleEquipment">
        <h2 class="text-lg font-bold">لوازم مورد نیاز</h2>
        <i class="fas fa-chevron-down"></i>
    </div>
    <div id="equipmentContent" class="mt-2 hidden">
        <div class="mb-4">
            <input id="equipmentInput" type="text" placeholder="نام لوازم..." class="w-full p-2 border rounded mb-2">
            <!-- اضافه کردن فیلد برآورد ریالی -->
            <input id="equipmentCostInput" type="number" placeholder="برآورد ریالی (ریال) - اختیاری" class="w-full p-2 border rounded mb-2" min="0">
            <button id="addEquipment" class="btn btn-success w-full">
                <i class="fas fa-plus mr-1"></i> افزودن
            </button>
        </div>
        <div id="equipmentList" class="mt-4"></div>
    </div>
</div>




<!-- ماموریت‌ها -->
<div class="bg-white p-4 rounded-lg shadow mb-4">
    <div class="toggle-missions" id="toggleMissions">
        <h2 class="text-lg font-bold">ماموریت‌ها</h2>
        <i class="fas fa-chevron-down"></i>
    </div>
    <div id="missionsContent" class="mt-2 hidden">
        <!-- فرم ثبت ماموریت جدید -->
        <div class="mb-4 p-4 border rounded">
            <h3 class="font-bold mb-2">ثبت ماموریت جدید</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">مقصد</label>
                    <input id="missionDestination" type="text" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">علت ماموریت</label>
                    <input id="missionReason" type="text" class="w-full p-2 border rounded">
                </div>
            </div>
            <button id="addMission" class="btn btn-success mt-4 w-full">
                <i class="fas fa-plus mr-1"></i> ثبت ماموریت
            </button>
        </div>

        <!-- جستجوی ماموریت‌ها -->
        <div class="mb-4">
            <input id="searchMissions" type="text" placeholder="جستجو در ماموریت‌ها..." 
                   class="w-full p-2 border rounded">
        </div>

        <!-- نمایش ماموریت‌های انجام نشده -->
        <div id="pendingMissionsList"></div>

        <!-- نمایش ماموریت‌های انجام شده -->
        <div class="mt-4">
            <label class="inline-flex items-center">
                <input type="checkbox" id="showCompletedMissions" class="mr-2">
                <span>نمایش ماموریت‌های انجام شده</span>
            </label>
            <div id="completedMissionsList" class="hidden mt-2"></div>
        </div>
    </div>
</div>
                
 


            </div>
        </div>  
</div>         

    <!-- آمار کارها -->




    <div class="task-stats">




        <div class="stat-item completed-stat">
            <span class="stat-value" id="completedCount">0</span>
            <span class="stat-label">انجام شده</span>
        </div>
        <div class="stat-item incomplete-stat">
            <span class="stat-value" id="incompleteCount">0</span>
            <span class="stat-label">انجام نشده</span>
        </div>
    </div>




    <!-- Date Picker Modal -->
    <div id="datePicker" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">انتقال کار به تاریخ جدید</h3>
            <div class="mb-4">
<button id="moveToToday" class="btn btn-warning mb-2 w-full">
    <i class="fas fa-calendar-day mr-1"></i> انتقال به امروز
</button>
                <button id="moveToNextDay" class="btn btn-primary mb-2 w-full">
                    <i class="fas fa-arrow-right mr-1"></i> انتقال به روز بعد
                </button>
                <button id="pickAnotherDate" class="btn btn-success w-full">
                    <i class="fas fa-calendar-alt mr-1"></i> انتخاب تاریخ دیگر
                </button>
            </div>
            <div class="flex justify-between items-center mb-2">
                <button id="prevPickerMonth" class="btn btn-primary">
                    <i class="fas fa-chevron-right mr-1"></i> ماه قبل
                </button>
                <h2 id="pickerMonthYear" class="text-lg font-bold"></h2>
                <button id="nextPickerMonth" class="btn btn-primary">
                    ماه بعد <i class="fas fa-chevron-left ml-1"></i>
                </button>
            </div>
            <div id="datePickerCalendar" class="grid grid-cols-7 gap-1 text-center hidden"></div>
            <button id="confirmDate" class="btn btn-success mt-2 w-full hidden">
                <i class="fas fa-check mr-1"></i> تایید
            </button>
            <button id="cancelDatePicker" class="btn btn-danger mt-2 w-full">
                <i class="fas fa-times mr-1"></i> لغو
            </button>
        </div>
    </div>

    <!-- Description Modal -->
    <div id="descriptionModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">توضیحات کار</h3>
            <textarea id="descriptionInput" class="description-input" placeholder="توضیحات کار..."></textarea>
            <div class="flex gap-2 mt-4">
                <button id="saveDescription" class="btn btn-success flex-1">
                    <i class="fas fa-save mr-1"></i> ذخیره
                </button>
                <button id="cancelDescription" class="btn btn-danger flex-1">
                    <i class="fas fa-times mr-1"></i> انصراف
                </button>
            </div>
        </div>
    </div>

    <!-- Assignee Modal -->
    <div id="assigneeModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">اختصاص کار به همکاران</h3>
            <div class="assignee-list" id="assigneeModalList">
                <!-- Checkboxes will be added dynamically -->
            </div>
            <div class="flex gap-2">
                <button id="saveAssignees" class="btn btn-success flex-1">
                    <i class="fas fa-save mr-1"></i> ذخیره
                </button>
                <button id="cancelAssignee" class="btn btn-danger flex-1">
                    <i class="fas fa-times mr-1"></i> انصراف
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editTaskModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">ویرایش کار</h3>
            <input id="editTaskInput" type="text" class="w-full p-2 border rounded mb-2" placeholder="متن کار...">
            <div class="mt-2">
                <label>اولویت:</label>
                <div class="priority-stars" id="editPriorityStars">
                    <i class="fas fa-star priority-star" data-value="3"></i>
                    <i class="fas fa-star priority-star" data-value="2"></i>
                    <i class="fas fa-star priority-star" data-value="1"></i>
                </div>
                <input type="hidden" id="editTaskPriority" value="0">
            </div>
            <div class="flex gap-2 mt-4">
                <button id="saveEditTask" class="btn btn-success flex-1">
                    <i class="fas fa-save mr-1"></i> ذخیره
                </button>
                <button id="cancelEditTask" class="btn btn-danger flex-1">
                    <i class="fas fa-times mr-1"></i> انصراف
                </button>
            </div>
        </div>
    </div>

<!-- Edit Equipment Modal -->
<div id="editEquipmentModal" class="modal-overlay">
    <div class="modal-content">
        <h3 class="text-lg font-bold mb-2">ویرایش لوازم</h3>
        <input id="editEquipmentInput" type="text" class="w-full p-2 border rounded mb-2" placeholder="نام لوازم...">
        <!-- اضافه کردن فیلد مبلغ در مودال ویرایش -->
        <input id="editEquipmentCostInput" type="number" class="w-full p-2 border rounded mb-2" placeholder="برآورد ریالی (ریال) - اختیاری" min="0">
        <div class="flex gap-2 mt-4">
            <button id="saveEditEquipment" class="btn btn-success flex-1">
                <i class="fas fa-save mr-1"></i> ذخیره
            </button>
            <button id="cancelEditEquipment" class="btn btn-danger flex-1">
                <i class="fas fa-times mr-1"></i> انصراف
            </button>
        </div>
    </div>
</div>

    <!-- Holidays Picker Modal -->
    <div id="holidaysPickerModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">انتخاب روزهای تعطیل</h3>
            <div class="flex justify-between items-center mb-4">
                <button id="prevHolidayMonth" class="btn btn-primary">
                    <i class="fas fa-chevron-right mr-1"></i> ماه قبل
                </button>
                <h2 id="holidayMonthYear" class="text-lg font-bold"></h2>
                <button id="nextHolidayMonth" class="btn btn-primary">
                    ماه بعد <i class="fas fa-chevron-left ml-1"></i>
                </button>
            </div>
            <div class="calendar-picker">
                <div id="holidaysPickerCalendar" class="grid grid-cols-7 gap-1 text-center"></div>
            </div>
            <div class="flex gap-2 mt-4">
                <button id="saveHolidays" class="btn btn-success flex-1">
                    <i class="fas fa-save mr-1"></i> ذخیره تعطیلات
                </button>
                <button id="cancelHolidaysPicker" class="btn btn-danger flex-1">
                    <i class="fas fa-times mr-1"></i> انصراف
                </button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">بازیابی اطلاعات از فایل اکسل</h3>
            <input type="file" id="backupFileInput" accept=".xlsx,.xls" class="w-full p-2 border rounded mb-4">
            <div class="flex gap-2">
                <button id="restoreBackup" class="btn btn-success flex-1">
                    <i class="fas fa-upload mr-1"></i> بازیابی اطلاعات
                </button>
                <button id="cancelBackup" class="btn btn-danger flex-1">
                    <i class="fas fa-times mr-1"></i> انصراف
                </button>
            </div>
            <div id="backupStatus" class="backup-status mt-2 hidden"></div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel">
        <h2 class="text-xl font-bold mb-4">تنظیمات</h2>
        
        <div class="settings-section">
            <div class="settings-section-header" id="teamMembersHeader">
                <h3 class="text-lg font-bold">همکاران</h3>
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="settings-section-content" id="teamMembersContent">
                <div id="teamMembersList" class="mb-4">
                    <!-- Team members will be added here dynamically -->
                </div>
                <div class="flex mb-4">
                    <input id="newTeamMember" type="text" placeholder="نام همکار جدید" class="p-2 border rounded w-full">
                    <button id="addTeamMember" class="btn btn-success mr-2">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
        
<div class="settings-section">
    <div class="settings-section-header" id="shiftsHeader">
        <h3 class="text-lg font-bold">تعریف شیفت‌ها</h3>
        <i class="fas fa-chevron-left"></i>
    </div>
    <div class="settings-section-content" id="shiftsContent">
        <div class="mb-4">
            <div class="grid grid-cols-3 gap-2 mb-2">
                <div>
                    <label class="block text-sm font-medium mb-1">روز اول</label>
                    <select id="shiftDay1" class="w-full p-2 border rounded">
                        <!-- Options will be added dynamically -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">روز دوم</label>
                    <select id="shiftDay2" class="w-full p-2 border rounded">
                        <!-- Options will be added dynamically -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">روز سوم</label>
                    <select id="shiftDay3" class="w-full p-2 border rounded">
                        <!-- Options will be added dynamically -->
                    </select>
                </div>
            </div>
            <button id="saveShifts" class="btn btn-primary w-full">
                <i class="fas fa-save mr-1"></i> ذخیره شیفت‌ها
            </button>
        </div>
    </div>
</div>

        
        <div class="settings-section">
            <div class="settings-section-header" id="holidaysHeader">
                <h3 class="text-lg font-bold">تعطیلات رسمی</h3>
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="settings-section-content" id="holidaysContent">
                <button id="openHolidaysPicker" class="btn btn-primary mb-4 w-full">
                    <i class="fas fa-calendar-alt mr-1"></i> انتخاب از تقویم
                </button>
                <div id="holidaysList" class="mb-4">
                    <!-- Holidays will be added here dynamically -->
                </div>
                <div class="flex mb-4">
                    <input id="newHoliday" type="text" placeholder="YYYY-MM-DD" class="p-2 border rounded w-full">
                    <button id="addHoliday" class="btn btn-success mr-2">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-section-header" id="backupHeader">
                <h3 class="text-lg font-bold">پشتیبان‌گیری و بازیابی</h3>
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="settings-section-content" id="backupContent">
                <div class="backup-section">
                    <h4 class="font-bold mb-2">پشتیبان‌گیری خودکار</h4>
                    <div class="backup-controls">
                        <button id="setBackupPath" class="btn btn-primary">
                            <i class="fas fa-folder mr-1"></i> انتخاب مسیر ذخیره
                        </button>
                        <button id="createBackup" class="btn btn-success">
                            <i class="fas fa-file-excel mr-1"></i> ایجاد پشتیبان
                        </button>
                    </div>
                    <div class="backup-path" id="backupPathDisplay">
                        مسیر ذخیره: <span id="backupPath">تنظیم نشده</span>
                    </div>
                    <div class="backup-status" id="lastBackupStatus">
                        آخرین پشتیبان: <span id="lastBackupTime">هیچ پشتیبانی گرفته نشده</span>
                    </div>
                </div>
                
                <div class="backup-section">
                    <h4 class="font-bold mb-2">بازیابی اطلاعات</h4>
                    <button id="openBackupModal" class="btn btn-warning w-full">
                        <i class="fas fa-upload mr-1"></i> بازیابی از فایل اکسل
                    </button>
                    <div class="backup-status hidden" id="restoreStatus"></div>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-section-header" id="passwordHeader">
                <h3 class="text-lg font-bold">تغییر رمز عبور</h3>
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="settings-section-content" id="passwordContent">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">رمز عبور فعلی</label>
                    <input id="currentPassword" type="password" class="w-full p-2 border rounded mb-2">
                    <label class="block text-sm font-medium mb-1">رمز عبور جدید</label>
                    <input id="newPassword" type="password" class="w-full p-2 border rounded mb-2">
                    <label class="block text-sm font-medium mb-1">تکرار رمز عبور جدید</label>
                    <input id="confirmNewPassword" type="password" class="w-full p-2 border rounded">
                </div>
                <button id="changePassword" class="btn btn-primary w-full">
                    <i class="fas fa-key mr-1"></i> تغییر رمز عبور
                </button>
                <div id="passwordChangeMessage" class="text-sm mt-2 hidden"></div>
            </div>
        </div>
        
        <button id="closeSettings" class="btn btn-danger w-full">
            <i class="fas fa-times mr-1"></i> بستن تنظیمات
        </button>
    </div>

    <script>
        // تنظیمات API
        const API_URL = "https://api.jsonbin.io/v3/b/6843ffef8a456b7966aa6e9e";
        const API_KEY = "$2a$10$K0GxG/YDDvwcCOicoQSc3OIPqPpUflP5JvKxVStM6sdQYjq4LdXKi";

        // رمز عبور پیش‌فرض
        let appPassword = localStorage.getItem('appPassword') || "1234";

let showCompletedTasks = false; // وضعیت نمایش کارهای انجام شده
        
        // متغیرهای داده‌ها
        let tasks = {};
        let notes = {};
        let holidays = [];
        let teamMembers = [];
        let shifts = {};
        let equipmentList = [];
let missions = [];
let ratings = []; // اضافه کردن این خط
        
        // تنظیمات پشتیبان‌گیری
        let backupSettings = JSON.parse(localStorage.getItem('backupSettings')) || {
            backupPath: '',
            lastBackupDate: null
        };
        
        let currentDate = new persianDate();
        let selectedDate = currentDate.clone();
        let holidaysPickerDate = currentDate.clone();
        let datePickerDate = currentDate.clone();
        let moveTaskContext = { date: '', index: -1 };
        let descriptionContext = { date: '', index: -1 };
        let assigneeContext = { date: '', index: -1 };
        let editTaskContext = { date: '', index: -1 };
        let editEquipmentIndex = -1;
        let recurringTasksMap = {}; // برای نگهداری کارهای تکراری
        let searchType = 'tasks'; // 'tasks' یا 'notes'
        let lastError = null; // آخرین خطای رخ داده



        // نمایش دایره چرخان
        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
        }

        // مخفی کردن دایره چرخان
        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }


function getRatedDates() {
    const ratedDates = new Set();
    if (ratings && Array.isArray(ratings)) {
        ratings.forEach(rating => {
            if (rating.date) {
                ratedDates.add(rating.date);
            }
        });
    }
    return Array.from(ratedDates);
}


function goToToday() {
    currentDate = new persianDate();
    selectedDate = currentDate.clone();
    renderCalendar();
    renderTasks();
    renderNote();
    showNotification('امروز نمایش داده شد');
}


        // نمایش پیام
        function showNotification(message, isSuccess = true, errorDetails = null) {
            const notification = document.getElementById('notification');
            const notificationContent = document.getElementById('notificationContent');
            
            notificationContent.textContent = message;
            notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
            notification.style.display = 'flex';
            
            // اگر خطا بود، پیام را تا زمان بسته شدن توسط کاربر نمایش می‌دهیم
            if (!isSuccess) {
                lastError = {
                    message: message,
                    details: errorDetails
                };
            } else {
                setTimeout(() => {
                    if (notification.style.display !== 'none') {
                        notification.style.display = 'none';
                    }
                }, 2000);
            }
        }

        // بستن پیام
        function closeNotification() {
            document.getElementById('notification').style.display = 'none';
            lastError = null;
        }

        // بارگذاری اولیه داده‌ها از فضای ابری
// بارگذاری اولیه داده‌ها از فضای ابری
async function loadInitialData() {
    showLoading();
    try {
        const response = await fetch(API_URL, {
            headers: {
                'X-Master-Key': API_KEY,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) throw new Error('خطا در بارگذاری داده‌ها');

        const data = await response.json();
        if (data.record) {
            // بارگذاری داده‌ها از دیتابیس
            tasks = data.record.tasks || {};
            notes = data.record.notes || {};
            holidays = data.record.holidays || [];
            teamMembers = data.record.teamMembers || ['همکار ۱', 'همکار ۲', 'همکار ۳', 'همکار ۴', 'همکار ۵', 'همکار ۶', 'همکار ۷', 'همکار ۸', 'همکار ۹', 'همکار ۱۰', 'همکار ۱۱', 'همکار ۱۲'];
            shifts = data.record.shifts || {
                pattern: ['همکار ۱', 'همکار ۲', 'همکار ۳'],
                startDate: new persianDate().format('YYYY-MM-DD')
            };
            equipmentList = data.record.equipmentList || [];
            missions = data.record.missions || [];
            ratings = data.record.ratings || [];
            
            // بارگذاری رمز عبور از دیتابیس (اگر وجود دارد)
            if (data.record.appPassword) {
                appPassword = data.record.appPassword;
                localStorage.setItem('appPassword', appPassword);
            }
            
            // بارگذاری تنظیمات پشتیبان‌گیری
            if (data.record.backupSettings) {
                backupSettings = data.record.backupSettings;
                localStorage.setItem('backupSettings', JSON.stringify(backupSettings));
            }
            
            // تبدیل فرمت داده‌های قدیمی لوازم (اگر لازم باشد)
            if (equipmentList.length > 0 && typeof equipmentList[0] === 'string') {
                equipmentList = equipmentList.map(item => ({ name: item, cost: null }));
                // ذخیره فرمت جدید در دیتابیس
                await saveToCloud();
            }
            
            // ذخیره در localStorage فقط اگر داده‌ای وجود نداشته باشد
            if (!localStorage.getItem('tasks')) {
                localStorage.setItem('tasks', JSON.stringify(tasks));
                localStorage.setItem('notes', JSON.stringify(notes));
                localStorage.setItem('holidays', JSON.stringify(holidays));
                localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
                localStorage.setItem('shifts', JSON.stringify(shifts));
                localStorage.setItem('equipment', JSON.stringify(equipmentList));
            }
            
            renderCalendar();
            renderTasks();
            renderHolidaysList();
            renderTeamMembersList();
            renderShiftSettings();
            updateTaskStats();
            setupMultiselect();
            renderAssigneeFilter();
            renderNote();
            renderEquipmentList();
            renderMissions();
            updateBackupUI();
            showNotification('داده‌ها با موفقیت بارگذاری شدند');
            
            // بررسی نیاز به پشتیبان‌گیری خودکار
            checkAutoBackup();
        }
    } catch (error) {
        console.error('Error loading initial data:', error);
        showNotification('خطا در بارگذاری داده‌ها', false, error.message);
        
        // اگر خطا در بارگذاری از دیتابیس رخ داد، از localStorage استفاده می‌کنیم
        tasks = JSON.parse(localStorage.getItem('tasks')) || {};
        notes = JSON.parse(localStorage.getItem('notes')) || {};
        holidays = JSON.parse(localStorage.getItem('holidays')) || [];
        teamMembers = JSON.parse(localStorage.getItem('teamMembers')) || ['همکار ۱', 'همکار ۲', 'همکار ۳', 'همکار ۴', 'همکار ۵', 'همکار ۶', 'همکار ۷', 'همکار ۸', 'همکار ۹', 'همکار ۱۰', 'همکار ۱۱', 'همکار ۱۲'];
        shifts = JSON.parse(localStorage.getItem('shifts')) || {
            pattern: ['همکار ۱', 'همکار ۲', 'همکار ۳'],
            startDate: new persianDate().format('YYYY-MM-DD')
        };
        equipmentList = JSON.parse(localStorage.getItem('equipment')) || [];
        missions = JSON.parse(localStorage.getItem('missions')) || [];
        backupSettings = JSON.parse(localStorage.getItem('backupSettings')) || {
            backupPath: '',
            lastBackupDate: null
        };
        
        // تبدیل فرمت داده‌های قدیمی لوازم در localStorage
        if (equipmentList.length > 0 && typeof equipmentList[0] === 'string') {
            equipmentList = equipmentList.map(item => ({ name: item, cost: null }));
            localStorage.setItem('equipment', JSON.stringify(equipmentList));
        }
        
        renderCalendar();
        renderTasks();
        renderHolidaysList();
        renderTeamMembersList();
        renderShiftSettings();
        updateTaskStats();
        setupMultiselect();
        renderAssigneeFilter();
        renderNote();
        renderEquipmentList();
        renderMissions();
        updateBackupUI();
        
        // بررسی نیاز به پشتیبان‌گیری خودکار
        checkAutoBackup();
    } finally {
        hideLoading();
    }
}

        // ذخیره داده‌ها در فضای ابری
async function saveToCloud() {
    showLoading();
    try {
        const dataToSave = { 
            tasks, 
            notes, 
            holidays, 
            teamMembers, 
            shifts,
            equipmentList,
            appPassword,
            missions,
            backupSettings,
            ratings // اضافه کردن این خط
        };

        const response = await fetch(API_URL, {
            method: 'PUT',
            headers: {
                'X-Master-Key': API_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dataToSave)
        });

        if (!response.ok) throw new Error('خطا در ذخیره داده‌ها');
        
        const result = await response.json();
        console.log('Data saved to cloud successfully:', result);
        showNotification('تغییرات با موفقیت ذخیره شد');
        return result;
    } catch (error) {
        console.error('Error saving to cloud:', error);
        showNotification('خطا در ذخیره تغییرات', false, error.message);
        throw error;
    } finally {
        hideLoading();
    }
}

        // ذخیره داده‌ها در localStorage
function saveTasks() {
    localStorage.setItem('tasks', JSON.stringify(tasks));
    localStorage.setItem('notes', JSON.stringify(notes));
    localStorage.setItem('holidays', JSON.stringify(holidays));
    localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
    localStorage.setItem('shifts', JSON.stringify(shifts));
    localStorage.setItem('equipment', JSON.stringify(equipmentList));
    localStorage.setItem('appPassword', appPassword);
    localStorage.setItem('backupSettings', JSON.stringify(backupSettings));
    localStorage.setItem('missions', JSON.stringify(missions));
    localStorage.setItem('ratings', JSON.stringify(ratings)); // اضافه کردن این خط
    updateTaskStats();
    
    // ذخیره در فضای ابری
    saveToCloud().catch(error => {
        console.error('Error saving to cloud:', error);
    });
}

        function isHoliday(date) {
            const dateStr = date.format('YYYY-MM-DD');
            return holidays.includes(dateStr);
        }

  function getShiftPerson(date) {
  try {
    if (!shifts || !Array.isArray(shifts.pattern) || shifts.pattern.length === 0) return null;
    // نقطه شروع ثابت: 1 تیر 1404 (Jalali)
    const startPD = new persianDate([1404, 4, 1]);
    const curPD = (date && typeof date.toDate === 'function') ? date : new persianDate(date);

    // تبدیل هر دو تاریخ شمسی به Date میلادی و نرمال‌سازی به UTC تا خطای DST نداشته باشیم
    const sG = startPD.toDate();
    const cG = curPD.toDate();
    const sUTC = Date.UTC(sG.getFullYear(), sG.getMonth(), sG.getDate());
    const cUTC = Date.UTC(cG.getFullYear(), cG.getMonth(), cG.getDate());

    const diffDays = Math.round((cUTC - sUTC) / 86400000); // اختلاف روز به‌صورت صحیح
    const n = shifts.pattern.length;
    const idx = ((diffDays % n) + n) % n; // مد مثبت برای تاریخ‌های قبل از شروع
    return shifts.pattern[idx];
  } catch (e) {
    console.error('Error in getShiftPerson:', e);
    return null;
  }
}

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const monthYear = document.getElementById('monthYear');
            calendar.innerHTML = '';

            const daysOfWeek = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];
            daysOfWeek.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'font-bold';
                calendar.appendChild(dayEl);
            });

            const firstDayOfMonth = currentDate.clone().startOf('month');
            const lastDayOfMonth = currentDate.clone().endOf('month');
            const startDay = firstDayOfMonth.day();
            const daysInMonth = lastDayOfMonth.date();

            monthYear.textContent = currentDate.format('MMMM YYYY');

            for (let i = 0; i < (startDay + 6) % 7; i++) {
                const emptyDay = document.createElement('div');
                calendar.appendChild(emptyDay);
            }

for (let i = 1; i <= daysInMonth; i++) {
    const dayEl = document.createElement('div');
    const date = currentDate.clone().date(i);
    const dateStr = date.format('YYYY-MM-DD');
    const hasNote = notes[dateStr] ? true : false;
    const taskCount = tasks[dateStr] ? tasks[dateStr].filter(task => !task.completed).length : 0;
    const shiftPerson = getShiftPerson(date);
    
    dayEl.innerHTML = `
        <div class="relative">
            <span class="${date.day() === 7 ? 'text-red-500 font-bold' : 'text-blue'}">${i}</span>
            ${hasNote ? `<span class="note-indicator"><i class="fas fa-pen text-green-200"></i></span>` : ''}
            ${taskCount > 0 ? `<span class="task-count-badge">${taskCount}</span>` : ''}
            ${shiftPerson ? `<div class="shift-name">${shiftPerson}</div>` : ''}
        </div>
    `;
    
    dayEl.className = 'calendar-day';
    
    if (isHoliday(date)) {
        dayEl.classList.add('holiday');
    }
    
    if (i === selectedDate.date() && currentDate.month() === selectedDate.month() && currentDate.year() === selectedDate.year()) {
        dayEl.classList.add('selected-day');
    }
    
    dayEl.addEventListener('click', () => {
        selectedDate = currentDate.clone().date(i);
        renderCalendar();
        renderTasks();
        renderNote();
    });
    calendar.appendChild(dayEl);
}
        }

function renderTasks() {
    const taskList = document.getElementById('taskList');
    const selectedDateStr = selectedDate.format('YYYY-MM-DD');
    document.getElementById('selectedDate').textContent = selectedDate.format('DD MMMM YYYY');

    taskList.innerHTML = '';
    
    if (tasks[selectedDateStr] && Array.isArray(tasks[selectedDateStr])) {
        // فیلتر کردن کارها بر اساس وضعیت نمایش کارهای انجام شده
        let tasksToShow = [...tasks[selectedDateStr]];
        
        // اگر نمایش کارهای انجام شده غیرفعال است، آنها را فیلتر کن
        if (!showCompletedTasks) {
            tasksToShow = tasksToShow.filter(task => !task.completed);
        }
        
        // اگر هیچ کاری برای نمایش نیست، پیام مناسب نشان بده
        if (tasksToShow.length === 0) {
            const message = showCompletedTasks ? 
                'هیچ کاری برای این روز ثبت نشده است' : 
                'هیچ کار انجام نشده‌ای برای این روز وجود ندارد';
            taskList.innerHTML = `<div class="text-center text-gray-500 py-4">${message}</div>`;
            return;
        }

        // مرتب‌سازی کارها
        const sortedTasks = [...tasksToShow].sort((a, b) => {
            // اولویت با کارهای انجام نشده
            if (a.completed && !b.completed) return 1;
            if (!a.completed && b.completed) return -1;
            
            // اگر مرتب‌سازی بر اساس همکار فعال است
            if (currentSortMethod === 'assignee') {
                const assigneeA = a.assignees && a.assignees.length > 0 ? 
                    teamMembers.indexOf(a.assignees[0]) : -1;
                const assigneeB = b.assignees && b.assignees.length > 0 ? 
                    teamMembers.indexOf(b.assignees[0]) : -1;
                
                if (assigneeA < assigneeB) return -1;
                if (assigneeA > assigneeB) return 1;
            }
            
            // مرتب‌سازی بر اساس اولویت (بالاترین اولویت اول)
            return (b.priority || 0) - (a.priority || 0);
        });

        // نمایش کارها
        if (currentSortMethod === 'assignee') {
            // نمایش گروه‌بندی شده بر اساس همکار
            const groupedTasks = {};
            sortedTasks.forEach(task => {
                const assignee = task.assignees && task.assignees.length > 0 ? 
                    task.assignees[0] : 'بدون اختصاص';
                
                if (!groupedTasks[assignee]) {
                    groupedTasks[assignee] = [];
                }
                groupedTasks[assignee].push(task);
            });

            Object.keys(groupedTasks).forEach(assignee => {
                // هدر گروه
                const groupHeader = document.createElement('div');
                groupHeader.className = 'group-header flex items-center';
                
                // رنگ بر اساس همکار
                let bgClass = 'bg-gray-100';
                if (assignee !== 'بدون اختصاص') {
                    const userIndex = teamMembers.indexOf(assignee);
                    if (userIndex >= 0 && userIndex < 12) {
                        bgClass = `user${userIndex + 1}-bg`;
                    }
                }
                
                groupHeader.innerHTML = `
                    <span class="${bgClass} px-3 py-1 rounded-full text-white">${assignee}</span>
                    <span class="mr-2">${groupedTasks[assignee].length} کار</span>
                `;
                taskList.appendChild(groupHeader);

                // نمایش کارهای هر گروه
                groupedTasks[assignee].forEach((task, index) => {
                    const originalIndex = tasks[selectedDateStr].indexOf(task);
                    renderTaskItem(taskList, task, originalIndex, selectedDateStr);
                });
            });
        } else {
            // نمایش ساده بر اساس اولویت
            sortedTasks.forEach((task, index) => {
                const originalIndex = tasks[selectedDateStr].indexOf(task);
                renderTaskItem(taskList, task, originalIndex, selectedDateStr);
            });
        }
    } else {
        const message = showCompletedTasks ? 
            'هیچ کاری برای این روز ثبت نشده است' : 
            'هیچ کار انجام نشده‌ای برای این روز وجود ندارد';
        taskList.innerHTML = `<div class="text-center text-gray-500 py-4">${message}</div>`;
    }
    
    renderIncompleteTasks();
    renderAssigneeTasks();
    updateTaskStats();
}

function toggleCompletedTasks() {
    showCompletedTasks = !showCompletedTasks;
    
    // به‌روزرسانی متن و آیکون دکمه
    const button = document.getElementById('toggleCompletedTasks');
    const icon = button.querySelector('i');
    const span = button.querySelector('span');
    
    if (showCompletedTasks) {
        icon.className = 'fas fa-eye ml-1';
        span.textContent = 'مخفی کردن کارهای انجام شده';
    } else {
        icon.className = 'fas fa-eye-slash ml-1';
        span.textContent = 'نمایش کارهای انجام شده';
    }
    
    // رندر مجدد لیست کارها
    renderTasks();
}

// تابع جداگانه برای رندر هر آیتم کار
function renderTaskItem(container, task, originalIndex, dateStr) {
    const taskEl = document.createElement('div');
    taskEl.className = 'task-item';
    
    // تعیین کلاس رنگ بر اساس افراد اختصاص داده شده
    let bgClass = '';
    if (task.assignees && task.assignees.length === 1) {
        const userIndex = teamMembers.indexOf(task.assignees[0]);
        if (userIndex >= 0 && userIndex < 12) {
            bgClass = `user${userIndex + 1}-bg`;
        }
    }
    
    const descriptionHtml = task.description ? 
        `<div class="task-description">${task.description}</div>` : 
        '';
    
    const assigneesHtml = task.assignees && task.assignees.length > 0 ? 
        `<div class="text-xs mt-1">اختصاص داده شده به: ${task.assignees.join('، ')}</div>` : 
        '';
    
    // ایجاد ستاره‌های اولویت
    const priorityStars = [];
    for (let i = 3; i >= 1; i--) {
        priorityStars.push(`<i class="fas fa-star priority-star ${task.priority >= i ? 'active' : ''}" 
            data-value="${i}" onclick="updateTaskPriority('${dateStr}', ${originalIndex}, ${i})"></i>`);
    }
    
    taskEl.innerHTML = `
        <div class="w-full ${bgClass} p-2 rounded">
            <div class="flex items-center">
                <div class="action-toggle" onclick="event.stopPropagation(); 
                    this.parentElement.parentElement.querySelector('.task-actions').classList.toggle('show-actions')">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
                <div class="task-actions">
                    <button onclick="toggleTask(${originalIndex})" class="btn btn-icon btn-sm ${task.completed ? 'btn-success' : 'btn-secondary'}" 
                        title="${task.completed ? 'لغو انجام' : 'انجام'}">
                        <i class="fas ${task.completed ? 'fa-check' : 'fa-circle'}"></i>
                    </button>
                    ${!task.completed ? `
                    <button onclick="openMoveTaskDialog('${dateStr}', ${originalIndex})" class="btn btn-icon btn-sm btn-warning" title="انتقال">
                        <i class="fas fa-arrow-right"></i>
                    </button>` : ''}
                    <button onclick="openDescriptionDialog('${dateStr}', ${originalIndex})" class="btn btn-icon btn-sm btn-secondary" title="توضیحات">
                        <i class="fas fa-comment"></i>
                    </button>
                    <button onclick="openAssigneeDialog('${dateStr}', ${originalIndex})" class="btn btn-icon btn-sm btn-primary" title="تغییر همکاران">
                        <i class="fas fa-users"></i>
                    </button>
                    <button onclick="openEditTaskDialog('${dateStr}', ${originalIndex})" class="btn btn-icon btn-sm btn-primary" title="ویرایش">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteTask('${dateStr}', ${originalIndex})" class="btn btn-icon btn-sm btn-danger" title="حذف">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <span class="task-text ${task.completed ? 'line-through' : ''}">${task.text}</span>
                <div class="priority-stars">
                    ${priorityStars.join('')}
                </div>
            </div>
            ${descriptionHtml}
            ${assigneesHtml}
        </div>
    `;
    container.appendChild(taskEl);
}

        function updateTaskPriority(date, index, priority) {
            if (tasks[date] && tasks[date][index]) {
                tasks[date][index].priority = priority;
                saveTasks();
                renderTasks();
            }
        }

        function renderNote() {
            const selectedDateStr = selectedDate.format('YYYY-MM-DD');
            const noteInput = document.getElementById('noteInput');
            const noteContent = document.getElementById('noteContent');
            
            noteInput.value = notes[selectedDateStr] || '';
            
            if (notes[selectedDateStr]) {
                noteContent.textContent = notes[selectedDateStr];
                noteContent.classList.remove('hidden');
            } else {
                noteContent.classList.add('hidden');
            }
        }

        function saveNote() {
            const selectedDateStr = selectedDate.format('YYYY-MM-DD');
            const noteInput = document.getElementById('noteInput');
            
            if (noteInput.value.trim()) {
                notes[selectedDateStr] = noteInput.value.trim();
            } else {
                delete notes[selectedDateStr];
            }
            
            saveTasks();
            renderNote();
            showNotification('یادداشت با موفقیت ذخیره شد');
        }

        function renderIncompleteTasks() {
            const incompleteTasks = document.getElementById('incompleteTasks');
            incompleteTasks.innerHTML = '';
            
            // جمع‌آوری همه کارهای انجام نشده
            let allIncompleteTasks = [];
            let uniqueRecurringTasks = new Set();
            
            Object.keys(tasks).forEach(date => {
                if (tasks[date] && Array.isArray(tasks[date])) {
                    tasks[date].forEach((task, index) => {
                        if (!task.completed) {
                            // اگر کار تکراری است، فقط یک نمونه از آن را نمایش می‌دهیم
                            if (task.recurring) {
                                const taskKey = task.text + (task.recurring.type || '') + (task.recurring.interval || '');
                                if (!uniqueRecurringTasks.has(taskKey)) {
                                    uniqueRecurringTasks.add(taskKey);
                                    allIncompleteTasks.push({
                                        date,
                                        index,
                                        task,
                                        persianDate: new persianDate(date),
                                        isRecurring: true
                                    });
                                }
                            } else {
                                allIncompleteTasks.push({
                                    date,
                                    index,
                                    task,
                                    persianDate: new persianDate(date),
                                    isRecurring: false
                                });
                            }
                        }
                    });
                }
            });
            
            // مرتب‌سازی بر اساس تاریخ (قدیمی‌ترین اول) و اولویت (بالاترین اولویت اول)
            allIncompleteTasks.sort((a, b) => {
                if (a.persianDate - b.persianDate !== 0) {
                    return a.persianDate - b.persianDate;
                }
                return (b.task.priority || 0) - (a.task.priority || 0);
            });
            
            // نمایش کارها
            allIncompleteTasks.forEach(item => {
                const taskEl = document.createElement('div');
                taskEl.className = 'task-item';
                
                // تعیین کلاس رنگ بر اساس افراد اختصاص داده شده
                let bgClass = '';
                if (item.task.assignees && item.task.assignees.length === 1) {
                    const userIndex = teamMembers.indexOf(item.task.assignees[0]);
                    if (userIndex >= 0 && userIndex < 12) {
                        bgClass = `user${userIndex + 1}-bg`;
                    }
                }
                
                const descriptionHtml = item.task.description ? 
                    `<div class="task-description">${item.task.description}</div>` : 
                    '';
                
                const recurringBadge = item.isRecurring ? 
                    '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2">تکراری</span>' : 
                    '';
                
                // ایجاد ستاره‌های اولویت
                const priorityStars = [];
                for (let i = 3; i >= 1; i--) {
                    priorityStars.push(`<i class="fas fa-star priority-star ${item.task.priority >= i ? 'active' : ''}" data-value="${i}" onclick="updateTaskPriority('${item.date}', ${item.index}, ${i})"></i>`);
                }
                
                taskEl.innerHTML = `
                    <div class="w-full ${bgClass} p-2 rounded">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="action-toggle" onclick="event.stopPropagation(); this.parentElement.parentElement.querySelector('.task-actions').classList.toggle('show-actions')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </div>
                                <div class="task-actions">
                                    <button onclick="toggleTaskFromList('${item.date}', ${item.index})" class="btn btn-icon btn-sm btn-secondary" title="انجام">
                                        <i class="fas fa-circle"></i>
                                    </button>
                                    <button onclick="openMoveTaskDialog('${item.date}', ${item.index})" class="btn btn-icon btn-sm btn-warning" title="انتقال">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button onclick="openDescriptionDialog('${item.date}', ${item.index})" class="btn btn-icon btn-sm btn-secondary" title="توضیحات">
                                        <i class="fas fa-comment"></i>
                                    </button>
                                    <button onclick="openAssigneeDialog('${item.date}', ${item.index})" class="btn btn-icon btn-sm btn-primary" title="تغییر همکاران">
                                        <i class="fas fa-users"></i>
                                    </button>
                                    <button onclick="openEditTaskDialog('${item.date}', ${item.index})" class="btn btn-icon btn-sm btn-primary" title="ویرایش">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteTask('${item.date}', ${item.index})" class="btn btn-icon btn-sm btn-danger" title="حذف">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                ${recurringBadge}
                                <span class="task-text">${item.task.text}</span>
                                <div class="priority-stars">
                                    ${priorityStars.join('')}
                                </div>
                            </div>
                            <span class="text-xs text-gray-500">${item.date}</span>
                        </div>
                        ${item.task.assignees && item.task.assignees.length > 0 ? 
                            `<div class="text-xs mt-1">اختصاص داده شده به: ${item.task.assignees.join('، ')}</div>` : ''}
                        ${descriptionHtml}
                    </div>
                `;
                incompleteTasks.appendChild(taskEl);
            });
        }

       function renderAssigneeTasks() {
    const assigneeTasks = document.getElementById('assigneeTasks');
    const selectedAssignee = document.getElementById('assigneeFilter').value;
    assigneeTasks.innerHTML = '';
    
    // جمع‌آوری همه کارهای اختصاص داده شده و انجام نشده
    let allAssigneeTasks = [];
    
    Object.keys(tasks).forEach(date => {
        if (tasks[date] && Array.isArray(tasks[date])) {
            tasks[date].forEach((task, index) => {
                if (!task.completed) {
                    // اگر گزینه "بدون اختصاص" انتخاب شده باشد
                    if (selectedAssignee === "unassigned") {
                        if (!task.assignees || task.assignees.length === 0) {
                            allAssigneeTasks.push({
                                date,
                                index,
                                task,
                                persianDate: new persianDate(date)
                            });
                        }
                    } 
                    // اگر گزینه "همه همکاران" انتخاب شده باشد
                    else if (!selectedAssignee) {
                        if (task.assignees && task.assignees.length > 0) {
                            allAssigneeTasks.push({
                                date,
                                index,
                                task,
                                persianDate: new persianDate(date)
                            });
                        }
                    } 
                    // اگر همکار خاصی انتخاب شده باشد
                    else if (task.assignees && task.assignees.includes(selectedAssignee)) {
                        allAssigneeTasks.push({
                            date,
                            index,
                            task,
                            persianDate: new persianDate(date)
                        });
                    }
                }
            });
        }
    });
    
    // بقیه کد بدون تغییر...
    // مرتب‌سازی و نمایش کارها همانطور که بود

            
            // مرتب‌سازی بر اساس تاریخ (قدیمی‌ترین اول) و اولویت (بالاترین اولویت اول)
            allAssigneeTasks.sort((a, b) => {
                if (a.persianDate - b.persianDate !== 0) {
                    return a.persianDate - b.persianDate;
                }
                return (b.task.priority || 0) - (a.task.priority || 0);
            });
            
            // نمایش کارها
            allAssigneeTasks.forEach(item => {
                const taskEl = document.createElement('div');
                taskEl.className = 'task-item';
                
                // تعیین کلاس رنگ بر اساس افراد اختصاص داده شده
                let bgClass = '';
                if (item.task.assignees && item.task.assignees.length === 1) {
                    const userIndex = teamMembers.indexOf(item.task.assignees[0]);
                    if (userIndex >= 0 && userIndex < 12) {
                        bgClass = `user${userIndex + 1}-bg`;
                    }
                }
                
                const descriptionHtml = item.task.description ? 
                    `<div class="task-description">${item.task.description}</div>` : 
                    '';
                
                const assigneesHtml = item.task.assignees && item.task.assignees.length > 0 ? 
                    `<div class="text-xs mt-1">اختصاص داده شده به: ${item.task.assignees.join('، ')}</div>` : 
                    '';
                
                // ایجاد ستاره‌های اولویت
                const priorityStars = [];
                for (let i = 3; i >= 1; i--) {
                    priorityStars.push(`<i class="fas fa-star priority-star ${item.task.priority >= i ? 'active' : ''}" data-value="${i}" onclick="updateTaskPriority('${item.date}', ${item.index}, ${i})"></i>`);
                }
                
                taskEl.innerHTML = `
                    <div class="w-full ${bgClass} p-2 rounded">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="action-toggle" onclick="event.stopPropagation(); this.parentElement.parentElement.querySelector('.task-actions').classList.toggle('show-actions')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </div>
                                <div class="task-actions">
                                    <button onclick="toggleTaskFromList('${item.date}', ${item.index})" class="btn btn-icon btn-sm btn-secondary" title="انجام">
                                        <i class="fas fa-circle"></i>
                                    </button>
                                    <button onclick="openMoveTaskDialog('${item.date}', ${item.index})" class="btn btn-icon btn-sm btn-warning" title="انتقال">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button onclick="openDescriptionDialog('${item.date}', ${item.index})" class="btn btn-icon btn-sm btn-secondary" title="توضیحات">
                                        <i class="fas fa-comment"></i>
                                    </button>
                                    <button onclick="openAssigneeDialog('${item.date}', ${item.index})" class="btn btn-icon btn-sm btn-primary" title="تغییر همکاران">
                                        <i class="fas fa-users"></i>
                                    </button>
                                    <button onclick="openEditTaskDialog('${item.date}', ${item.index})" class="btn btn-icon btn-sm btn-primary" title="ویرایش">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteTask('${item.date}', ${item.index})" class="btn btn-icon btn-sm btn-danger" title="حذف">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <span class="task-text">${item.task.text}</span>
                                <div class="priority-stars">
                                    ${priorityStars.join('')}
                                </div>
                            </div>
                            <span class="text-xs text-gray-500">${item.date}</span>
                        </div>
                        ${descriptionHtml}
                        ${assigneesHtml}
                    </div>
                `;
                assigneeTasks.appendChild(taskEl);
            });
        }

        function renderAssigneeFilter() {
            const assigneeFilter = document.getElementById('assigneeFilter');
            assigneeFilter.innerHTML = '<option value="">همه همکاران</option>';
            assigneeFilter.innerHTML += '<option value="unassigned">بدون اختصاص</option>';
            
            teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                assigneeFilter.appendChild(option);
            });
        }

        function updateTaskStats() {
            let completedCount = 0;
            let incompleteCount = 0;
            let uniqueRecurringTasks = new Set();
            
            Object.keys(tasks).forEach(date => {
                if (tasks[date] && Array.isArray(tasks[date])) {
                    tasks[date].forEach(task => {
                        if (task.completed) {
                            completedCount++;
                        } else {
                            // اگر کار تکراری است، فقط یک بار شمارش می‌کنیم
                            if (task.recurring) {
                                const taskKey = task.text + (task.recurring.type || '') + (task.recurring.interval || '');
                                if (!uniqueRecurringTasks.has(taskKey)) {
                                    uniqueRecurringTasks.add(taskKey);
                                    incompleteCount++;
                                }
                            } else {
                                incompleteCount++;
                            }
                        }
                    });
                }
            });
            
            document.getElementById('completedCount').textContent = completedCount;
            document.getElementById('incompleteCount').textContent = incompleteCount;
        }

        function toggleTask(index) {
            const selectedDateStr = selectedDate.format('YYYY-MM-DD');
            if (tasks[selectedDateStr] && tasks[selectedDateStr][index]) {
                tasks[selectedDateStr][index].completed = !tasks[selectedDateStr][index].completed;
                saveTasks();
                renderTasks();
                renderCalendar();
                showNotification('وضعیت کار با موفقیت تغییر کرد');
            }
        }

        function toggleTaskFromList(date, index) {
            if (tasks[date] && tasks[date][index]) {
                tasks[date][index].completed = !tasks[date][index].completed;
                saveTasks();
                renderTasks();
                renderCalendar();
                showNotification('وضعیت کار با موفقیت تغییر کرد');
            }
        }

        function deleteTask(date, index) {
            if (confirm('آیا از حذف این کار مطمئن هستید؟')) {
                if (tasks[date] && tasks[date][index]) {
                    tasks[date].splice(index, 1);
                    if (tasks[date].length === 0) {
                        delete tasks[date];
                    }
                    saveTasks();
                    renderTasks();
                    renderCalendar();
                    showNotification('کار با موفقیت حذف شد');
                }
            }
        }

        function openMoveTaskDialog(date, index) {
            moveTaskContext = { date, index };
            document.getElementById('datePicker').style.display = 'flex';
            document.getElementById('datePickerCalendar').classList.add('hidden');
            document.getElementById('confirmDate').classList.add('hidden');
            document.getElementById('moveToNextDay').classList.remove('hidden');
            document.getElementById('pickAnotherDate').classList.remove('hidden');
        }

        function moveTaskToNextDay() {
            const nextDay = new persianDate(moveTaskContext.date).add('days', 1).format('YYYY-MM-DD');
            moveTaskToDate(nextDay);
        }

        function showDatePickerCalendar() {
            document.getElementById('moveToNextDay').classList.add('hidden');
            document.getElementById('pickAnotherDate').classList.add('hidden');
            document.getElementById('datePickerCalendar').classList.remove('hidden');
            document.getElementById('confirmDate').classList.remove('hidden');
            
            renderDatePickerCalendar();
        }

        function renderDatePickerCalendar() {
            const calendar = document.getElementById('datePickerCalendar');
            const monthYear = document.getElementById('pickerMonthYear');
            calendar.innerHTML = '';
            
            const daysOfWeek = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];
            daysOfWeek.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'font-bold';
                calendar.appendChild(dayEl);
            });
            
            const firstDayOfMonth = datePickerDate.clone().startOf('month');
            const lastDayOfMonth = datePickerDate.clone().endOf('month');
            const startDay = firstDayOfMonth.day();
            const daysInMonth = lastDayOfMonth.date();
            
            monthYear.textContent = datePickerDate.format('MMMM YYYY');
            
            for (let i = 0; i < (startDay + 6) % 7; i++) {
                const emptyDay = document.createElement('div');
                calendar.appendChild(emptyDay);
            }
            
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = i;
                dayEl.className = 'calendar-day';
                
                const date = datePickerDate.clone().date(i);
                if (date.day() === 7) {
                    dayEl.classList.add('text-red-500', 'font-bold');
                }
                if (isHoliday(date)) {
                    dayEl.classList.add('holiday');
                }
                
                dayEl.addEventListener('click', () => {
                    const selectedDay = datePickerDate.clone().date(i);
                    document.getElementById('confirmDate').dataset.date = selectedDay.format('YYYY-MM-DD');
                });
                
                calendar.appendChild(dayEl);
            }
        }

        function moveTaskToDate(newDateStr) {
            const task = tasks[moveTaskContext.date] && tasks[moveTaskContext.date][moveTaskContext.index];
            if (!task || task.completed) return;

            tasks[moveTaskContext.date].splice(moveTaskContext.index, 1);
            if (tasks[moveTaskContext.date].length === 0) delete tasks[moveTaskContext.date];
            if (!tasks[newDateStr]) tasks[newDateStr] = [];
            tasks[newDateStr].push(task);
            saveTasks();
            renderTasks();
            renderCalendar();
            closeDatePicker();
            showNotification('کار با موفقیت منتقل شد');
        }

        function closeDatePicker() {
            document.getElementById('datePicker').style.display = 'none';
        }

        function openDescriptionDialog(date, index) {
            descriptionContext = { date, index };
            const task = tasks[date] && tasks[date][index];
            if (task) {
                document.getElementById('descriptionInput').value = task.description || '';
                document.getElementById('descriptionModal').style.display = 'flex';
            }
        }

        function saveDescription() {
            const description = document.getElementById('descriptionInput').value;
            if (tasks[descriptionContext.date] && tasks[descriptionContext.date][descriptionContext.index]) {
                tasks[descriptionContext.date][descriptionContext.index].description = description;
                saveTasks();
                renderTasks();
                closeDescriptionDialog();
                showNotification('توضیحات با موفقیت ذخیره شد');
            }
        }

        function closeDescriptionDialog() {
            document.getElementById('descriptionModal').style.display = 'none';
        }

        function openAssigneeDialog(date, index) {
            assigneeContext = { date, index };
            const task = tasks[date] && tasks[date][index];
            if (task) {
                const assigneeList = document.getElementById('assigneeModalList');
                assigneeList.innerHTML = '';
                
                teamMembers.forEach(member => {
                    const assigneeItem = document.createElement('div');
                    assigneeItem.className = 'assignee-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `assignee-${member}`;
                    checkbox.value = member;
                    checkbox.checked = task.assignees && task.assignees.includes(member);
                    
                    const label = document.createElement('label');
                    label.htmlFor = `assignee-${member}`;
                    label.textContent = member;
                    label.style.marginRight = '0.5rem';
                    
                    assigneeItem.appendChild(checkbox);
                    assigneeItem.appendChild(label);
                    assigneeList.appendChild(assigneeItem);
                });
                
                document.getElementById('assigneeModal').style.display = 'flex';
            }
        }

        function saveAssignees() {
            const assigneeList = document.getElementById('assigneeModalList');
            const checkboxes = assigneeList.querySelectorAll('input[type="checkbox"]:checked');
            const assignees = Array.from(checkboxes).map(checkbox => checkbox.value);
            
            if (tasks[assigneeContext.date] && tasks[assigneeContext.date][assigneeContext.index]) {
                tasks[assigneeContext.date][assigneeContext.index].assignees = assignees;
                saveTasks();
                renderTasks();
                closeAssigneeDialog();
                showNotification('تغییرات همکاران با موفقیت ذخیره شد');
            }
        }

        function closeAssigneeDialog() {
            document.getElementById('assigneeModal').style.display = 'none';
        }

        function openEditTaskDialog(date, index) {
            editTaskContext = { date, index };
            const task = tasks[date] && tasks[date][index];
            if (task) {
                document.getElementById('editTaskInput').value = task.text;
                document.getElementById('editTaskPriority').value = task.priority || 0;
                
                // تنظیم ستاره‌های اولویت
                const stars = document.querySelectorAll('#editPriorityStars .priority-star');
                stars.forEach(star => {
                    star.classList.remove('active');
                    if (parseInt(star.dataset.value) <= (task.priority || 0)) {
                        star.classList.add('active');
                    }
                });
                
                document.getElementById('editTaskModal').style.display = 'flex';
            }
        }

        function saveEditTask() {
            const newText = document.getElementById('editTaskInput').value;
            const newPriority = parseInt(document.getElementById('editTaskPriority').value) || 0;
            
            if (tasks[editTaskContext.date] && tasks[editTaskContext.date][editTaskContext.index]) {
                tasks[editTaskContext.date][editTaskContext.index].text = newText;
                tasks[editTaskContext.date][editTaskContext.index].priority = newPriority;
                saveTasks();
                renderTasks();
                closeEditTaskDialog();
                showNotification('کار با موفقیت ویرایش شد');
            }
        }

        function closeEditTaskDialog() {
            document.getElementById('editTaskModal').style.display = 'none';
        }

        async function addTask() {
            const taskText = document.getElementById('taskInput').value;
            const isRecurring = document.getElementById('isRecurring').checked;
            const recurringType = document.getElementById('recurringType').value;
            const recurringInterval = parseInt(document.getElementById('recurringInterval').value) || 1;
            const priority = parseInt(document.getElementById('taskPriority').value) || 0;
            
            // دریافت افراد اختصاص داده شده
            const assignees = [];
            const checkboxes = document.querySelectorAll('#checkboxes input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                assignees.push(checkbox.value);
            });

            if (!taskText) {
                showNotification('لطفاً متن کار را وارد کنید', false);
                return;
            }

            const selectedDateStr = selectedDate.format('YYYY-MM-DD');
            if (!tasks[selectedDateStr]) tasks[selectedDateStr] = [];

            const task = { 
                text: taskText, 
                completed: false,
                assignees: assignees,
                priority: priority
            };
            
            try {
                showLoading();
                
                if (isRecurring) {
                    task.recurring = { type: recurringType, interval: recurringInterval };
                    addRecurringTasks(task, selectedDateStr);
                } else {
                    tasks[selectedDateStr].push(task);
                }

                await saveToCloud();
                
                document.getElementById('taskInput').value = '';
                document.getElementById('isRecurring').checked = false;
                document.getElementById('recurringOptions').classList.add('hidden');
                document.getElementById('taskPriority').value = 0;
                // ریست ستاره‌های اولویت
                document.querySelectorAll('#priorityStars .priority-star').forEach(star => {
                    star.classList.remove('active');
                });
                // پاک کردن انتخاب افراد
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                renderTasks();
                renderCalendar();
                showNotification('کار با موفقیت اضافه شد');
            } catch (error) {
                console.error('Error adding task:', error);
                showNotification('خطا در ذخیره کار', false, `افزودن کار "${taskText}" با شکست مواجه شد`);
            } finally {
                hideLoading();
            }
        }

        function addRecurringTasks(task, startDateStr) {
            const startDate = new persianDate(startDateStr);
            tasks[startDateStr].push({ ...task });

            let nextDate = startDate.clone();
            for (let i = 0; i < 12; i++) {
                if (task.recurring.type === 'weekly') {
                    nextDate = nextDate.add('days', 7 * task.recurring.interval);
                } else if (task.recurring.type === 'daily') {
                    nextDate = nextDate.add('days', task.recurring.interval);
                } else if (task.recurring.type === 'monthly') {
                    nextDate = nextDate.add('months', task.recurring.interval);
                }
                const nextDateStr = nextDate.format('YYYY-MM-DD');
                if (!tasks[nextDateStr]) tasks[nextDateStr] = [];
                tasks[nextDateStr].push({ ...task });
            }
        }

        function searchTasks() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const startDate = document.getElementById('searchStartDate').value;
            const endDate = document.getElementById('searchEndDate').value;
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';

            const start = startDate ? new persianDate(startDate) : null;
            const end = endDate ? new persianDate(endDate) : null;

            if (searchType === 'tasks') {
                // جستجو در کارها
                Object.keys(tasks).forEach(date => {
                    const taskDate = new persianDate(date);
                    if (start && taskDate.isBefore(start)) return;
                    if (end && taskDate.isAfter(end)) return;

                    if (tasks[date] && Array.isArray(tasks[date])) {
                        tasks[date].forEach((task, index) => {
                            const matchesText = searchInput && 
                                (task.text.toLowerCase().includes(searchInput)) || 
                                 (task.description && task.description.toLowerCase().includes(searchInput));
                            
                            if (searchInput && !matchesText) return;
                            
                            const taskEl = document.createElement('div');
                            taskEl.className = 'task-item';
                            
                            // تعیین کلاس رنگ بر اساس افراد اختصاص داده شده
                            let bgClass = '';
                            if (task.assignees && task.assignees.length === 1) {
                                const userIndex = teamMembers.indexOf(task.assignees[0]);
                                if (userIndex >= 0 && userIndex < 12) {
                                    bgClass = `user${userIndex + 1}-bg`;
                                }
                            }
                            
                            const descriptionHtml = task.description ? 
                                `<div class="task-description">${task.description}</div>` : 
                                '';
                            
                            const assigneesHtml = task.assignees && task.assignees.length > 0 ? 
                                `<div class="text-xs mt-1">اختصاص داده شده به: ${task.assignees.join('، ')}</div>` : 
                                '';
                            
                            // ایجاد ستاره‌های اولویت
                            const priorityStars = [];
                            for (let i = 3; i >= 1; i--) {
                                priorityStars.push(`<i class="fas fa-star priority-star ${task.priority >= i ? 'active' : ''}" data-value="${i}" onclick="updateTaskPriority('${date}', ${index}, ${i})"></i>`);
                            }
                            
                            taskEl.innerHTML = `
                                <div class="w-full ${bgClass} p-2 rounded">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="action-toggle" onclick="event.stopPropagation(); this.parentElement.parentElement.querySelector('.task-actions').classList.toggle('show-actions')">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </div>
                                            <div class="task-actions">
                                                <button onclick="toggleTaskFromList('${date}', ${index})" class="btn btn-icon btn-sm ${task.completed ? 'btn-success' : 'btn-secondary'}" title="${task.completed ? 'لغو انجام' : 'انجام'}">
                                                    <i class="fas ${task.completed ? 'fa-check' : 'fa-circle'}"></i>
                                                </button>
                                                ${!task.completed ? `
                                                <button onclick="openMoveTaskDialog('${date}', ${index})" class="btn btn-icon btn-sm btn-warning" title="انتقال">
                                                    <i class="fas fa-arrow-right"></i>
                                                </button>` : ''}
                                                <button onclick="openDescriptionDialog('${date}', ${index})" class="btn btn-icon btn-sm btn-secondary" title="توضیحات">
                                                    <i class="fas fa-comment"></i>
                                                </button>
                                                <button onclick="openAssigneeDialog('${date}', ${index})" class="btn btn-icon btn-sm btn-primary" title="تغییر همکاران">
                                                    <i class="fas fa-users"></i>
                                                </button>
                                                <button onclick="openEditTaskDialog('${date}', ${index})" class="btn btn-icon btn-sm btn-primary" title="ویرایش">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="deleteTask('${date}', ${index})" class="btn btn-icon btn-sm btn-danger" title="حذف">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            <span class="task-text ${task.completed ? 'line-through' : ''}">${task.text}</span>
                                            <div class="priority-stars">
                                                ${priorityStars.join('')}
                                            </div>
                                        </div>
                                        <span class="text-xs text-gray-500">${date}</span>
                                    </div>
                                    ${descriptionHtml}
                                    ${assigneesHtml}
                                </div>
                            `;
                            searchResults.appendChild(taskEl);
                        });
                    }
                });
            } else {
                // جستجو در یادداشتها
                Object.keys(notes).forEach(date => {
                    const noteDate = new persianDate(date);
                    if (start && noteDate.isBefore(start)) return;
                    if (end && noteDate.isAfter(end)) return;

                    const noteContent = notes[date];
                    if (searchInput && !noteContent.toLowerCase().includes(searchInput)) return;
                    
                    const noteEl = document.createElement('div');
                    noteEl.className = 'task-item';
                    noteEl.innerHTML = `
                        <div class="w-full p-2 rounded">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="task-text">${noteContent}</span>
                                </div>
                                <span class="text-xs text-gray-500">${date}</span>
                            </div>
                        </div>
                    `;
                    searchResults.appendChild(noteEl);
                });
            }
        }

        function setupLiveSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchStartDate = document.getElementById('searchStartDate');
            const searchEndDate = document.getElementById('searchEndDate');

            const performSearch = () => {
                searchTasks();
            };

            searchInput.addEventListener('input', performSearch);
            searchStartDate.addEventListener('change', performSearch);
            searchEndDate.addEventListener('change', performSearch);
        }

        function toggleSearchSection() {
            const searchSection = document.getElementById('searchSection');
            searchSection.classList.toggle('hidden');
            if (!searchSection.classList.contains('hidden')) {
                searchTasks();
            }
        }

        function toggleSettingsPanel() {
            const settingsPanel = document.getElementById('settingsPanel');
            settingsPanel.classList.toggle('open');
        }

        function toggleIncompleteTasks() {
            const incompleteTasks = document.getElementById('incompleteTasks');
            const toggleBtn = document.getElementById('toggleIncompleteTasks');
            
            incompleteTasks.classList.toggle('hidden');
            toggleBtn.classList.toggle('active');
        }

        function toggleAssigneeTasks() {
            const assigneeTasksSection = document.getElementById('assigneeTasksSection');
            const toggleBtn = document.getElementById('toggleAssigneeTasks');
            
            assigneeTasksSection.classList.toggle('hidden');
            toggleBtn.classList.toggle('active');
            
            if (!assigneeTasksSection.classList.contains('hidden')) {
                renderAssigneeTasks();
            }
        }

        function toggleSettingsSection(sectionId) {
            const header = document.getElementById(`${sectionId}Header`);
            const content = document.getElementById(`${sectionId}Content`);
            
            // بستن همه بخش‌ها
            document.querySelectorAll('.settings-section-content').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.settings-section-header').forEach(h => {
                h.classList.remove('active');
            });
            
            // باز کردن بخش انتخاب شده
            header.classList.add('active');
            content.classList.add('active');
        }

        function renderHolidaysList() {
            const holidaysList = document.getElementById('holidaysList');
            holidaysList.innerHTML = '';
            
            holidays.forEach((holiday, index) => {
                const holidayItem = document.createElement('div');
                holidayItem.className = 'holiday-item';
                holidayItem.innerHTML = `
                    <button onclick="removeHoliday(${index})" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i>
                    </button>
                    <span class="holiday-date">${holiday}</span>
                `;
                holidaysList.appendChild(holidayItem);
            });
        }

        function renderTeamMembersList() {
            const teamMembersList = document.getElementById('teamMembersList');
            teamMembersList.innerHTML = '';
            
            teamMembers.forEach((member, index) => {
                const memberItem = document.createElement('div');
                memberItem.className = 'holiday-item';
                memberItem.innerHTML = `
                    <button onclick="removeTeamMember(${index})" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i>
                    </button>
                    <span class="holiday-date">${member}</span>
                `;
                teamMembersList.appendChild(memberItem);
            });
            
            // به‌روزرسانی selectها برای شیفت‌ها
            renderShiftSettings();
            // به‌روزرسانی multiselect برای اختصاص کارها
            setupMultiselect();
            // به‌روزرسانی فیلتر همکاران
            renderAssigneeFilter();
        }

    function renderShiftSettings() {
    const shiftDay1 = document.getElementById('shiftDay1');
    const shiftDay2 = document.getElementById('shiftDay2');
    const shiftDay3 = document.getElementById('shiftDay3');
    
    // پاک کردن گزینه‌های قبلی
    shiftDay1.innerHTML = '';
    shiftDay2.innerHTML = '';
    shiftDay3.innerHTML = '';
    
    // اضافه کردن گزینه‌های جدید
    teamMembers.forEach(member => {
        const option = document.createElement('option');
        option.value = member;
        option.textContent = member;
        
        shiftDay1.appendChild(option.cloneNode(true));
        shiftDay2.appendChild(option.cloneNode(true));
shiftDay3.appendChild(option.cloneNode(true));
    });
    
    // تنظیم مقادیر قبلی اگر وجود داشته باشد
    if (shifts.pattern && shifts.pattern.length >= 3) {
        shiftDay1.value = shifts.pattern[0] || '';
        shiftDay2.value = shifts.pattern[1] || '';
        shiftDay3.value = shifts.pattern[2] || '';
    }
}



function saveShifts() {
    const shiftDay1 = document.getElementById('shiftDay1').value;
    const shiftDay2 = document.getElementById('shiftDay2').value;
    const shiftDay3 = document.getElementById('shiftDay3').value;
    
    if (!shiftDay1 || !shiftDay2 || !shiftDay3) {
        showNotification('لطفاً تمام فیلدها را پر کنید', false);
        return;
    }
    
    // تاریخ شروع ثابت - 1 تیر 1404
    const fixedStartDate = '1404-04-01';
    
    shifts = {
        pattern: [shiftDay1, shiftDay2, shiftDay3],
        startDate: fixedStartDate
    };
    
    saveTasks();
    renderCalendar();
    showNotification('شیفت‌ها با موفقیت ذخیره شدند');
}

        function setupMultiselect() {
            const multiselect = document.querySelector('.multiselect');
            const selectBox = multiselect.querySelector('.select-box');
            const overSelect = multiselect.querySelector('.over-select');
            const checkboxes = multiselect.querySelector('#checkboxes');
            
            // پاک کردن چک‌باکس‌های قبلی
            checkboxes.innerHTML = '';
            
            // اضافه کردن چک‌باکس‌های جدید برای هر همکار
            teamMembers.forEach(member => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = member;
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(member));
                checkboxes.appendChild(label);
            });
            
            overSelect.addEventListener('click', function() {
                checkboxes.style.display = checkboxes.style.display === 'block' ? 'none' : 'block';
            });
        }

        function addHoliday() {
            const newHolidayInput = document.getElementById('newHoliday');
            const newHoliday = newHolidayInput.value.trim();
            
            if (newHoliday && !holidays.includes(newHoliday)) {
                holidays.push(newHoliday);
                saveTasks();
                renderHolidaysList();
                renderCalendar();
                newHolidayInput.value = '';
                showNotification('تعطیلی با موفقیت اضافه شد');
            }
        }

        function addTeamMember() {
            const newMemberInput = document.getElementById('newTeamMember');
            const newMember = newMemberInput.value.trim();
            
            if (newMember && !teamMembers.includes(newMember)) {
                teamMembers.push(newMember);
                saveTasks();
                renderTeamMembersList();
                newMemberInput.value = '';
                showNotification('همکار با موفقیت اضافه شد');
            }
        }

        function removeHoliday(index) {
            holidays.splice(index, 1);
            saveTasks();
            renderHolidaysList();
            renderCalendar();
            showNotification('تعطیلی با موفقیت حذف شد');
        }

        function removeTeamMember(index) {
            if (confirm('آیا از حذف این همکار مطمئن هستید؟ این عمل ممکن است بر روی شیفت‌ها و کارهای اختصاص داده شده تأثیر بگذارد.')) {
                teamMembers.splice(index, 1);
                saveTasks();
                renderTeamMembersList();
                renderCalendar();
                showNotification('همکار با موفقیت حذف شد');
            }
        }

        function openHolidaysPicker() {
            renderHolidaysPickerCalendar();
            document.getElementById('holidaysPickerModal').style.display = 'flex';
        }

        function renderHolidaysPickerCalendar() {
            const calendar = document.getElementById('holidaysPickerCalendar');
            const monthYear = document.getElementById('holidayMonthYear');
            calendar.innerHTML = '';

            const daysOfWeek = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];
            daysOfWeek.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'font-bold';
                calendar.appendChild(dayEl);
            });

            const firstDayOfMonth = holidaysPickerDate.clone().startOf('month');
            const lastDayOfMonth = holidaysPickerDate.clone().endOf('month');
            const startDay = firstDayOfMonth.day();
            const daysInMonth = lastDayOfMonth.date();

            monthYear.textContent = holidaysPickerDate.format('MMMM YYYY');

            for (let i = 0; i < (startDay + 6) % 7; i++) {
                const emptyDay = document.createElement('div');
                calendar.appendChild(emptyDay);
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                const date = holidaysPickerDate.clone().date(i);
                const dateStr = date.format('YYYY-MM-DD');
                
                dayEl.textContent = i;
                dayEl.className = 'calendar-day';
                
                if (date.day() === 7) {
                    dayEl.classList.add('text-red-500', 'font-bold');
                }
                
                if (holidays.includes(dateStr)) {
                    dayEl.classList.add('selected-holiday');
                }
                
                dayEl.addEventListener('click', () => {
                    const index = holidays.indexOf(dateStr);
                    if (index === -1) {
                        holidays.push(dateStr);
                        dayEl.classList.add('selected-holiday');
                    } else {
                        holidays.splice(index, 1);
                        dayEl.classList.remove('selected-holiday');
                    }
                });
                
                calendar.appendChild(dayEl);
            }
        }

        function saveHolidays() {
            saveTasks();
            renderCalendar();
            renderHolidaysList();
            closeHolidaysPicker();
            showNotification('تعطیلات با موفقیت ذخیره شدند');
        }

        function closeHolidaysPicker() {
            document.getElementById('holidaysPickerModal').style.display = 'none';
        }

        function changeSearchType(type) {
            searchType = type;
            document.querySelectorAll('.search-option').forEach(option => {
                if (option.dataset.type === type) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            searchTasks();
        }

        // تنظیم اولویت با ستاره‌ها
        function setupPriorityStars() {
            const stars = document.querySelectorAll('#priorityStars .priority-star');
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const value = parseInt(star.dataset.value);
                    document.getElementById('taskPriority').value = value;
                    
                    // فعال کردن ستاره‌های انتخاب شده
                    stars.forEach((s, i) => {
                        if (i < value) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
            
            const editStars = document.querySelectorAll('#editPriorityStars .priority-star');
            editStars.forEach(star => {
                star.addEventListener('click', () => {
                    const value = parseInt(star.dataset.value);
                    document.getElementById('editTaskPriority').value = value;
                    
                    // فعال کردن ستاره‌های انتخاب شده
                    editStars.forEach((s, i) => {
                        if (i < value) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
        }

        // تابع ورود با رمز عبور
        function login() {
            const passwordInput = document.getElementById('passwordInput').value;
            const errorElement = document.getElementById('passwordError');
            
            if (passwordInput === appPassword) {
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } else {
                errorElement.classList.remove('hidden');
                errorElement.textContent = 'رمز عبور اشتباه است';
            }
        }

        // تابع تغییر رمز عبور
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const messageElement = document.getElementById('passwordChangeMessage');
            
            messageElement.classList.add('hidden');
            
            if (currentPassword !== appPassword) {
                messageElement.textContent = 'رمز عبور فعلی اشتباه است';
                messageElement.classList.remove('hidden');
                messageElement.classList.remove('hidden');
                messageElement.classList.add('text-red-500');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                messageElement.textContent = 'رمز عبور جدید و تکرار آن مطابقت ندارند';
                messageElement.classList.remove('hidden');
                messageElement.classList.add('text-red-500');
                return;
            }
            
            if (newPassword.length < 4) {
                messageElement.textContent = 'رمز عبور باید حداقل 4 کاراکتر باشد';

                messageElement.classList.add('text-red-500');
                return;
            }
            
            // ذخیره رمز جدید در متغیر و localStorage
            appPassword = newPassword;
            localStorage.setItem('appPassword', appPassword);
            
            // ذخیره در دیتابیس
            saveToCloud().then(() => {
                messageElement.textContent = 'رمز عبور با موفقیت تغییر کرد و در دیتابیس ذخیره شد';
                messageElement.classList.remove('hidden');
                messageElement.classList.remove('text-red-500');
                messageElement.classList.add('text-green-500');
                
                // پاک کردن فیلدها
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
            }).catch(error => {
                messageElement.textContent = 'خطا در ذخیره رمز عبور در دیتابیس';
                messageElement.classList.remove('hidden');
                messageElement.classList.add('text-red-500');
                console.error('Error saving password:', error);
            });
        }

        // بخش مدیریت لوازم مورد نیاز
// تابع نمایش لیست لوازم
function renderEquipmentList() {
    const equipmentListElement = document.getElementById('equipmentList');
    equipmentListElement.innerHTML = '';
    
    equipmentList.forEach((equipment, index) => {
        const equipmentItem = document.createElement('div');
        equipmentItem.className = 'equipment-item';
        
        // نمایش مبلغ اگر وجود داشته باشد
        const costDisplay = equipment.cost ? 
            `<span class="text-green-600 ml-2">${equipment.cost.toLocaleString('fa-IR')} ریال</span>` : 
            '<span class="text-gray-500 ml-2">هزینه وارد نشده</span>';
        
        equipmentItem.innerHTML = `
            <div class="w-full p-2 rounded">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="action-toggle" onclick="event.stopPropagation(); this.parentElement.parentElement.querySelector('.equipment-actions').classList.toggle('show-actions')">
                            <i class="fas fa-ellipsis-v"></i>
                        </div>
                        <div class="equipment-actions">
                            <button onclick="openEditEquipmentDialog(${index})" class="btn btn-icon btn-sm btn-primary" title="ویرایش">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="markEquipmentAsPurchased(${index})" class="btn btn-icon btn-sm btn-success" title="خرید شد">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                        <span class="task-text">${equipment.name}</span>
                        ${costDisplay}
                    </div>
                </div>
            </div>
        `;
        
        equipmentListElement.appendChild(equipmentItem);
    });
}

function addEquipment() {
    const equipmentInput = document.getElementById('equipmentInput');
    const equipmentCostInput = document.getElementById('equipmentCostInput');
    const equipmentName = equipmentInput.value.trim();
    const equipmentCost = equipmentCostInput.value.trim() ? parseInt(equipmentCostInput.value.trim()) : null;
    
    if (!equipmentName) {
        showNotification('لطفاً نام لوازم را وارد کنید', false);
        return;
    }
    
    // ایجاد شیء لوازم جدید با مبلغ
    const newEquipment = {
        name: equipmentName,
        cost: equipmentCost
    };
    
    equipmentList.push(newEquipment);
    saveTasks();
    renderEquipmentList();
    equipmentInput.value = '';
    equipmentCostInput.value = '';
    showNotification('لوازم با موفقیت اضافه شد');
}

// تابع باز کردن مودال ویرایش لوازم
function openEditEquipmentDialog(index) {
    editEquipmentIndex = index;
    const equipment = equipmentList[index];
    document.getElementById('editEquipmentInput').value = equipment.name;
    document.getElementById('editEquipmentCostInput').value = equipment.cost || '';
    document.getElementById('editEquipmentModal').style.display = 'flex';
}

// تابع ذخیره ویرایش لوازم
function saveEditEquipment() {
    const newName = document.getElementById('editEquipmentInput').value.trim();
    const newCost = document.getElementById('editEquipmentCostInput').value.trim() ? 
        parseInt(document.getElementById('editEquipmentCostInput').value.trim()) : null;
    
    if (!newName) {
        showNotification('لطفاً نام لوازم را وارد کنید', false);
        return;
    }
    
    if (editEquipmentIndex >= 0 && editEquipmentIndex < equipmentList.length) {
        equipmentList[editEquipmentIndex].name = newName;
        equipmentList[editEquipmentIndex].cost = newCost;
        saveTasks();
        renderEquipmentList();
        closeEditEquipmentDialog();
        showNotification('لوازم با موفقیت ویرایش شد');
    }
}

// تابع بستن مودال ویرایش لوازم
function closeEditEquipmentDialog() {
    document.getElementById('editEquipmentModal').style.display = 'none';
    editEquipmentIndex = -1;
}

        function markEquipmentAsPurchased(index) {
            if (confirm('آیا این لوازم خریداری شده است؟')) {
                equipmentList.splice(index, 1);
                saveTasks();
                renderEquipmentList();
                showNotification('وضعیت لوازم به "خریداری شده" تغییر کرد');
            }
        }

        // بخش پشتیبان‌گیری و بازیابی
        function updateBackupUI() {
            const backupPathDisplay = document.getElementById('backupPath');
            const lastBackupTimeDisplay = document.getElementById('lastBackupTime');
            
            backupPathDisplay.textContent = backupSettings.backupPath || 'تنظیم نشده';
            
            if (backupSettings.lastBackupDate) {
                const lastBackupDate = new Date(backupSettings.lastBackupDate);
                lastBackupTimeDisplay.textContent = lastBackupDate.toLocaleString('fa-IR');
            } else {
                lastBackupTimeDisplay.textContent = 'هیچ پشتیبانی گرفته نشده';
            }
        }

        function setBackupPath() {
            // در مرورگرهای مدرن می‌توان از showDirectoryPicker استفاده کرد
            if ('showDirectoryPicker' in window) {
                window.showDirectoryPicker()
                    .then(directoryHandle => {
                        // ذخیره مسیر دایرکتوری
                        backupSettings.backupPath = directoryHandle.name;
                        saveTasks();
                        updateBackupUI();
                        showNotification('مسیر ذخیره پشتیبان با موفقیت تنظیم شد');
                    })
                    .catch(error => {
                        console.error('Error selecting directory:', error);
                        showNotification('خطا در انتخاب مسیر ذخیره', false);
                    });
            } else {
                // در مرورگرهای قدیمی از input file استفاده می‌کنیم
                const input = document.createElement('input');
                input.type = 'file';
                input.webkitdirectory = true;
                input.multiple = false;
                
                input.onchange = (e) => {
                    const files = e.target.files;
                    if (files.length > 0) {
                        backupSettings.backupPath = files[0].webkitRelativePath.split('/')[0];
                        saveTasks();
                        updateBackupUI();
                        showNotification('مسیر ذخیره پشتیبان با موفقیت تنظیم شد');
                    }
                };
                
                input.click();
            }
        }

        function createExcelBackup() {
            if (!backupSettings.backupPath) {
                showNotification('لطفاً ابتدا مسیر ذخیره پشتیبان را تنظیم کنید', false);
                return;
            }
            
            try {
                showLoading();
                
                // ایجاد یک workbook جدید
                const wb = XLSX.utils.book_new();
                
                // ایجاد sheet برای کارها
                const tasksData = [];
                Object.keys(tasks).forEach(date => {
                    if (tasks[date] && Array.isArray(tasks[date])) {
                        tasks[date].forEach(task => {
                            tasksData.push({
                                تاریخ: date,
                                کار: task.text,
                                وضعیت: task.completed ? 'انجام شده' : 'انجام نشده',
                                اولویت: task.priority || 0,
                                'تکرار شونده': task.recurring ? 'بله' : 'خیر',
                                'نوع تکرار': task.recurring?.type || '',
                                'فاصله تکرار': task.recurring?.interval || '',
                                'اختصاص داده شده به': task.assignees?.join('، ') || '',
                                توضیحات: task.description || ''
                            });
                        });
                    }
                });
                
                const tasksSheet = XLSX.utils.json_to_sheet(tasksData);
                XLSX.utils.book_append_sheet(wb, tasksSheet, "کارها");
                
                // ایجاد sheet برای یادداشت‌ها
                const notesData = Object.keys(notes).map(date => ({
                    تاریخ: date,
                    یادداشت: notes[date]
                }));
                
                const notesSheet = XLSX.utils.json_to_sheet(notesData);
                XLSX.utils.book_append_sheet(wb, notesSheet, "یادداشت‌ها");
                
                // ایجاد sheet برای تعطیلات
                const holidaysSheet = XLSX.utils.json_to_sheet(holidays.map(date => ({
                    تاریخ: date
                })));
                XLSX.utils.book_append_sheet(wb, holidaysSheet, "تعطیلات");
                
                // ایجاد sheet برای همکاران
                const teamMembersSheet = XLSX.utils.json_to_sheet(teamMembers.map(member => ({
                    همکار: member
                })));
                XLSX.utils.book_append_sheet(wb, teamMembersSheet, "همکاران");
                
                // ایجاد sheet برای شیفت‌ها
                const shiftsSheet = XLSX.utils.json_to_sheet([{
                    'روز اول': shifts.pattern?.[0] || '',
                    'روز دوم': shifts.pattern?.[1] || '',
                    'روز سوم': shifts.pattern?.[2] || '',
                    'تاریخ شروع': shifts.startDate || ''
                }]);
                XLSX.utils.book_append_sheet(wb, shiftsSheet, "شیفت‌ها");
                
                // ایجاد sheet برای لوازم
                const equipmentSheet = XLSX.utils.json_to_sheet(equipmentList.map(item => ({
                    لوازم: item
                })));
                XLSX.utils.book_append_sheet(wb, equipmentSheet, "لوازم");
                
                // ایجاد فایل اکسل
                const fileName = `سررسید_دیجیتال_${new persianDate().format('YYYY-MM-DD')}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                // ذخیره تاریخ آخرین پشتیبان
                backupSettings.lastBackupDate = new Date().toISOString();
                saveTasks();
                updateBackupUI();
                
                showNotification('پشتیبان با موفقیت ایجاد شد');
            } catch (error) {
                console.error('Error creating backup:', error);
                showNotification('خطا در ایجاد پشتیبان', false, error.message);
            } finally {
                hideLoading();
            }
        }

        function checkAutoBackup() {
            // بررسی آیا امروز پشتیبان گرفته شده یا نه
            const today = new persianDate().format('YYYY-MM-DD');
            const lastBackupDate = backupSettings.lastBackupDate ? 
                new persianDate(backupSettings.lastBackupDate).format('YYYY-MM-DD') : null;
            
            if (backupSettings.backupPath && lastBackupDate !== today) {
                createExcelBackup();
            }
        }

        function openBackupModal() {
            document.getElementById('backupModal').style.display = 'flex';
            document.getElementById('backupStatus').classList.add('hidden');
        }

        function closeBackupModal() {
            document.getElementById('backupModal').style.display = 'none';
        }

        function restoreFromExcel() {
            const fileInput = document.getElementById('backupFileInput');
            const statusElement = document.getElementById('backupStatus');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showNotification('لطفاً یک فایل اکسل انتخاب کنید', false);
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    showLoading();
                    statusElement.classList.add('hidden');
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // بازیابی کارها
                    if (workbook.Sheets['کارها']) {
                        const tasksData = XLSX.utils.sheet_to_json(workbook.Sheets['کارها']);
                        tasks = {};
                        
                        tasksData.forEach(task => {
                            if (!tasks[task.تاریخ]) tasks[task.تاریخ] = [];
                            
                            const newTask = {
                                text: task.کار,
                                completed: task.وضعیت === 'انجام شده',
                                priority: task.اولویت || 0
                            };
                            
                            if (task.توضیحات) {
                                newTask.description = task.توضیحات;
                            }
                            
                            if (task['اختصاص داده شده به']) {
                                newTask.assignees = task['اختصاص داده شده به'].split('، ');
                            }
                            
                            if (task['تکرار شونده'] === 'بله') {
                                newTask.recurring = {
                                    type: task['نوع تکرار'],
                                    interval: task['فاصله تکرار']
                                };
                            }
                            
                            tasks[task.تاریخ].push(newTask);
                        });
                    }
                    
                    // بازیابی یادداشت‌ها
                    if (workbook.Sheets['یادداشت‌ها']) {
                        const notesData = XLSX.utils.sheet_to_json(workbook.Sheets['یادداشت‌ها']);
                        notes = {};
                        
                        notesData.forEach(note => {
                            if (note.یادداشت) {
                                notes[note.تاریخ] = note.یادداشت;
                            }
                        });
                    }
                    
                    // بازیابی تعطیلات
                    if (workbook.Sheets['تعطیلات']) {
                        const holidaysData = XLSX.utils.sheet_to_json(workbook.Sheets['تعطیلات']);
                        holidays = holidaysData.map(item => item.تاریخ);
                    }
                    
                    // بازیابی همکاران
                    if (workbook.Sheets['همکاران']) {
                        const teamMembersData = XLSX.utils.sheet_to_json(workbook.Sheets['همکاران']);
                        teamMembers = teamMembersData.map(item => item.همکار);
                    }
                    
                    // بازیابی شیفت‌ها
                    if (workbook.Sheets['شیفت‌ها']) {
                        const shiftsData = XLSX.utils.sheet_to_json(workbook.Sheets['شیفت‌ها']);
                        if (shiftsData.length > 0) {
                            shifts = {
                                pattern: [
                                    shiftsData[0]['روز اول'],
                                    shiftsData[0]['روز دوم'],
                                    shiftsData[0]['روز سوم']
                                ].filter(Boolean),
                                startDate: shiftsData[0]['تاریخ شروع'] || new persianDate().format('YYYY-MM-DD')
                            };
                        }
                    }
                    
                    // بازیابی لوازم
                    if (workbook.Sheets['لوازم']) {
                        const equipmentData = XLSX.utils.sheet_to_json(workbook.Sheets['لوازم']);
                        equipmentList = equipmentData.map(item => item.لوازم);
                    }
                    
                    // ذخیره داده‌های بازیابی شده
                    saveTasks();
                    
                    // رندر مجدد همه چیز
                    renderCalendar();
                    renderTasks();
                    renderHolidaysList();
                    renderTeamMembersList();
                    renderShiftSettings();
                    renderEquipmentList();
                    updateBackupUI();
                    
                    statusElement.textContent = 'اطلاعات با موفقیت بازیابی شدند';
                    statusElement.classList.remove('hidden');
                    statusElement.classList.remove('backup-error');
                    statusElement.classList.add('backup-success');
                    
                    showNotification('اطلاعات با موفقیت از فایل اکسل بازیابی شدند');
                } catch (error) {
                    console.error('Error restoring backup:', error);
                    statusElement.textContent = 'خطا در بازیابی اطلاعات: ' + error.message;
                    statusElement.classList.remove('hidden');
                    statusElement.classList.remove('backup-success');
                    statusElement.classList.add('backup-error');
                    
                    showNotification('خطا در بازیابی اطلاعات', false, error.message);
                } finally {
                    hideLoading();
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // رویدادهای کلیک
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate = currentDate.subtract('months', 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate = currentDate.add('months', 1);
            renderCalendar();
        });

        document.getElementById('prevHolidayMonth').addEventListener('click', () => {
            holidaysPickerDate = holidaysPickerDate.subtract('months', 1);
            renderHolidaysPickerCalendar();
        });

        document.getElementById('nextHolidayMonth').addEventListener('click', () => {
            holidaysPickerDate = holidaysPickerDate.add('months', 1);
            renderHolidaysPickerCalendar();
        });

        document.getElementById('prevPickerMonth').addEventListener('click', () => {
            datePickerDate = datePickerDate.subtract('months', 1);
            renderDatePickerCalendar();
        });

        document.getElementById('nextPickerMonth').addEventListener('click', () => {
            datePickerDate = datePickerDate.add('months', 1);
            renderDatePickerCalendar();
        });

        document.getElementById('addTask').addEventListener('click', addTask);
        document.getElementById('isRecurring').addEventListener('change', (e) => {
            document.getElementById('recurringOptions').classList.toggle('hidden', !e.target.checked);
        });
        document.getElementById('moveToNextDay').addEventListener('click', moveTaskToNextDay);
        document.getElementById('pickAnotherDate').addEventListener('click', showDatePickerCalendar);
        document.getElementById('confirmDate').addEventListener('click', () => {
            const newDateStr = document.getElementById('confirmDate').dataset.date;
            if (newDateStr) {
                moveTaskToDate(newDateStr);
            }
        });
        document.getElementById('cancelDatePicker').addEventListener('click', closeDatePicker);
        document.getElementById('searchToggle').addEventListener('click', toggleSearchSection);
        document.getElementById('settingsToggle').addEventListener('click', toggleSettingsPanel);
        document.getElementById('closeSettings').addEventListener('click', toggleSettingsPanel);
        document.getElementById('addHoliday').addEventListener('click', addHoliday);
        document.getElementById('addTeamMember').addEventListener('click', addTeamMember);
        document.getElementById('saveShifts').addEventListener('click', saveShifts);
        document.getElementById('openHolidaysPicker').addEventListener('click', openHolidaysPicker);
        document.getElementById('saveHolidays').addEventListener('click', saveHolidays);
        document.getElementById('cancelHolidaysPicker').addEventListener('click', closeHolidaysPicker);
        document.getElementById('saveDescription').addEventListener('click', saveDescription);
        document.getElementById('cancelDescription').addEventListener('click', closeDescriptionDialog);
        document.getElementById('saveAssignees').addEventListener('click', saveAssignees);
        document.getElementById('cancelAssignee').addEventListener('click', closeAssigneeDialog);
        document.getElementById('saveEditTask').addEventListener('click', saveEditTask);
        document.getElementById('cancelEditTask').addEventListener('click', closeEditTaskDialog);
        document.getElementById('saveNote').addEventListener('click', saveNote);
        document.getElementById('toggleIncompleteTasks').addEventListener('click', toggleIncompleteTasks);
        document.getElementById('toggleAssigneeTasks').addEventListener('click', toggleAssigneeTasks);
        document.getElementById('assigneeFilter').addEventListener('change', renderAssigneeTasks);
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('changePassword').addEventListener('click', changePassword);
        document.getElementById('addEquipment').addEventListener('click', addEquipment);
        document.getElementById('saveEditEquipment').addEventListener('click', saveEditEquipment);
        document.getElementById('cancelEditEquipment').addEventListener('click', closeEditEquipmentDialog);
        document.getElementById('setBackupPath').addEventListener('click', setBackupPath);
        document.getElementById('createBackup').addEventListener('click', createExcelBackup);
        document.getElementById('openBackupModal').addEventListener('click', openBackupModal);
        document.getElementById('restoreBackup').addEventListener('click', restoreFromExcel);
        document.getElementById('cancelBackup').addEventListener('click', closeBackupModal);
        document.getElementById('toggleCompletedTasks').addEventListener('click', toggleCompletedTasks);
        
        // اضافه کردن رویداد Enter برای ورود
        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                login();
            }
        });
        
        // رویدادهای بخش تنظیمات
        document.getElementById('teamMembersHeader').addEventListener('click', () => toggleSettingsSection('teamMembers'));
        document.getElementById('shiftsHeader').addEventListener('click', () => toggleSettingsSection('shifts'));
        document.getElementById('holidaysHeader').addEventListener('click', () => toggleSettingsSection('holidays'));
        document.getElementById('backupHeader').addEventListener('click', () => toggleSettingsSection('backup'));
        document.getElementById('passwordHeader').addEventListener('click', () => toggleSettingsSection('password'));

        // رویدادهای جستجو
        document.querySelectorAll('.search-option').forEach(option => {
            option.addEventListener('click', () => {
                changeSearchType(option.dataset.type);
            });
        });

        // فونت فارسی
        const fontLink = document.createElement('link');
        fontLink.href = 'https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css';
        fontLink.rel = 'stylesheet';
        document.head.appendChild(fontLink);

        // بارگذاری اولیه داده‌ها
        loadInitialData();
        renderCalendar();
        renderTasks();
        setupLiveSearch();
        setupPriorityStars();
        
        // نمایش صفحه ورود
        document.getElementById('passwordModal').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'none';

document.getElementById('goToToday').addEventListener('click', goToToday);

// دکمه انتقال کار به امروز
document.getElementById('moveToToday').addEventListener('click', () => {
    if (moveTaskContext.date && moveTaskContext.index !== -1) {
        const todayStr = new persianDate().format('YYYY-MM-DD');

        if (!tasks[todayStr]) tasks[todayStr] = [];

        const movedTask = tasks[moveTaskContext.date][moveTaskContext.index];
        tasks[todayStr].push(movedTask);
        tasks[moveTaskContext.date].splice(moveTaskContext.index, 1);

        saveTasks();
        renderTasks();
        renderCalendar();
        closeDatePicker();
        showNotification('کار به امروز منتقل شد');
    }
});

// متغیر برای ذخیره وضعیت مرتب‌سازی
let currentSortMethod = 'assignee'; // یا 'priority'

document.getElementById('sortByAssignee').addEventListener('click', () => {
    currentSortMethod = 'assignee';
    renderTasks();
});

document.getElementById('sortByPriority').addEventListener('click', () => {
    currentSortMethod = 'priority';
    renderTasks();
});


function toggleEquipment() {
    const equipmentContent = document.getElementById('equipmentContent');
    const toggleBtn = document.getElementById('toggleEquipment');
    
    equipmentContent.classList.toggle('hidden');
    toggleBtn.classList.toggle('active');
}

// اضافه کردن رویداد کلیک
document.getElementById('toggleEquipment').addEventListener('click', toggleEquipment);



// متغیرهای مربوط به ماموریت‌ها

let currentMissionsFilter = '';

// تابع نمایش/مخفی کردن بخش ماموریت‌ها
function toggleMissions() {
    const missionsContent = document.getElementById('missionsContent');
    const toggleBtn = document.getElementById('toggleMissions');
    
    missionsContent.classList.toggle('hidden');
    toggleBtn.classList.toggle('active');
}

// تابع ثبت ماموریت جدید
function addMission() {
    const destination = document.getElementById('missionDestination').value.trim();
    const reason = document.getElementById('missionReason').value.trim();
    
    if (!destination || !reason) {
        showNotification('لطفاً مقصد و علت ماموریت را وارد کنید', false);
        return;
    }
    
    const newMission = {
        id: Date.now(),
        destination,
        reason,
        date: new persianDate().format('YYYY-MM-DD HH:mm'),
        completed: false,
        assignee: null,
        result: null
    };
    
    missions.push(newMission);
    saveMissions();
    renderMissions();
saveTasks(); 
    
    document.getElementById('missionDestination').value = '';
    document.getElementById('missionReason').value = '';
    
    showNotification('ماموریت با موفقیت ثبت شد');
}

// تابع ذخیره ماموریت‌ها
async function saveMissions() {
    localStorage.setItem('missions', JSON.stringify(missions));
    
    try {
        showLoading();
        const dataToSave = { 
            tasks, 
            notes, 
            holidays, 
            teamMembers, 
            shifts,
            equipmentList,
            appPassword,
            missions, // اضافه کردن ماموریت‌ها به داده‌های ذخیره شده
            backupSettings,
            ratings
        };

        const response = await fetch(API_URL, {
            method: 'PUT',
            headers: {
                'X-Master-Key': API_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dataToSave)
        });

        if (!response.ok) throw new Error('خطا در ذخیره ماموریت‌ها');
        
        showNotification('تغییرات ماموریت‌ها با موفقیت ذخیره شد');
    } catch (error) {
        console.error('Error saving missions:', error);
        showNotification('خطا در ذخیره تغییرات ماموریت‌ها', false, error.message);
    } finally {
        hideLoading();
    }
}

// تابع بارگذاری ماموریت‌ها
function loadMissions() {
    const savedMissions = localStorage.getItem('missions');
    if (savedMissions) {
        missions = JSON.parse(savedMissions);
    }
}

// تابع رندر ماموریت‌ها
function renderMissions() {
    const pendingList = document.getElementById('pendingMissionsList');
    const completedList = document.getElementById('completedMissionsList');
    
    pendingList.innerHTML = '';
    completedList.innerHTML = '';
    
    // فیلتر کردن بر اساس جستجو
    const filteredMissions = missions.filter(mission => {
        const matchesSearch = currentMissionsFilter === '' || 
            mission.destination.includes(currentMissionsFilter) || 
            mission.reason.includes(currentMissionsFilter);
        
        return matchesSearch;
    });
    
    // تقسیم به انجام شده و انجام نشده
    const pendingMissions = filteredMissions.filter(m => !m.completed);
    const completedMissions = filteredMissions.filter(m => m.completed);
    
    // نمایش ماموریت‌های انجام نشده
    if (pendingMissions.length === 0) {
        pendingList.innerHTML = '<div class="text-center text-gray-500 py-4">ماموریت انجام نشده‌ای وجود ندارد</div>';
    } else {
        pendingMissions.forEach(mission => {
            pendingList.appendChild(createMissionElement(mission));
        });
    }
    
    // نمایش ماموریت‌های انجام شده
    if (completedMissions.length === 0) {
        completedList.innerHTML = '<div class="text-center text-gray-500 py-4">ماموریت انجام شده‌ای وجود ندارد</div>';
    } else {
        completedMissions.forEach(mission => {
            completedList.appendChild(createMissionElement(mission));
        });
    }
}

// تابع ایجاد المان ماموریت
function createMissionElement(mission) {
    const missionEl = document.createElement('div');
    missionEl.className = `mission-item ${mission.completed ? 'completed-mission' : ''}`;
    
    const missionContent = document.createElement('div');
    missionContent.className = 'flex items-center justify-between';
    
    missionContent.innerHTML = `
        <div class="flex items-center">
            <div class="action-toggle" onclick="event.stopPropagation(); this.parentElement.parentElement.querySelector('.mission-actions').classList.toggle('show-actions')">
                <i class="fas fa-ellipsis-v"></i>
            </div>
            <div class="mission-actions">
                ${!mission.completed ? `
                <button onclick="completeMission(${mission.id})" class="btn btn-icon btn-sm btn-success" title="انجام شد">
                    <i class="fas fa-check"></i>
                </button>
                <button onclick="editMission(${mission.id})" class="btn btn-icon btn-sm btn-primary" title="ویرایش">
                    <i class="fas fa-edit"></i>
                </button>
                ` : ''}
                <button onclick="deleteMission(${mission.id})" class="btn btn-icon btn-sm btn-danger" title="حذف">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="mr-2">
                <div><span class="font-bold">مقصد:</span> ${mission.destination}</div>
                <div><span class="font-bold">علت:</span> ${mission.reason}</div>
                ${mission.completed ? `
                    <div><span class="font-bold">اعزامی:</span> ${mission.assignee}</div>
                    <div><span class="font-bold">نتیجه:</span> ${mission.result}</div>
                ` : ''}
            </div>
        </div>
        <div class="text-sm text-gray-500">${mission.date}</div>
    `;
    
    missionEl.appendChild(missionContent);
    return missionEl;
}
// تابع تکمیل ماموریت
function completeMission(missionId) {
    event.stopPropagation();
    const mission = missions.find(m => m.id === missionId);
    if (!mission) return;
    
    const assignee = prompt('نام فرد اعزامی را وارد کنید:');
    if (!assignee) return;
    
    const result = prompt('نتیجه ماموریت را وارد کنید:');
    if (!result) return;
    
    mission.completed = true;
    mission.assignee = assignee;
    mission.result = result;
    
    saveMissions();
    renderMissions();
    
    showNotification('وضعیت ماموریت به "انجام شده" تغییر کرد');
}

function editMission(missionId) {
    event.stopPropagation();
    const mission = missions.find(m => m.id === missionId);
    if (!mission) return;
    
    const newDestination = prompt('مقصد جدید را وارد کنید:', mission.destination);
    if (!newDestination) return;
    
    const newReason = prompt('علت جدید را وارد کنید:', mission.reason);
    if (!newReason) return;
    
    mission.destination = newDestination;
    mission.reason = newReason;
    
    saveMissions();
    renderMissions();
    
    showNotification('ماموریت با موفقیت ویرایش شد');
}

function deleteMission(missionId) {
    event.stopPropagation();
    if (confirm('آیا از حذف این ماموریت مطمئن هستید؟')) {
        missions = missions.filter(m => m.id !== missionId);
        saveMissions();
        renderMissions();
        
        showNotification('ماموریت با موفقیت حذف شد');
    }
}

// تابع جستجوی ماموریت‌ها
function searchMissions() {
    currentMissionsFilter = document.getElementById('searchMissions').value;
    renderMissions();
}

// تابع نمایش/مخفی کردن ماموریت‌های انجام شده
function toggleCompletedMissions() {
    const completedList = document.getElementById('completedMissionsList');
    completedList.classList.toggle('hidden');
}

function toggleMissionActions(missionId) {
    // بستن همه پنل‌های دیگر
    document.querySelectorAll('.mission-actions').forEach(panel => {
        if (panel.id !== `mission-actions-${missionId}`) {
            panel.classList.remove('show-actions');
        }
    });
    
    // toggle پنل جاری
    const actions = document.getElementById(`mission-actions-${missionId}`);
    actions.classList.toggle('show-actions');
}

// بستن پنل‌های عملیاتی با کلیک در هر جای صفحه
document.addEventListener('click', (e) => {
    if (!e.target.closest('.mission-actions-toggle') && !e.target.closest('.mission-actions')) {
        document.querySelectorAll('.mission-actions').forEach(actionPanel => {
            actionPanel.classList.remove('show-actions');
        });
    }
});

// رویدادها
document.getElementById('toggleMissions').addEventListener('click', toggleMissions);
document.getElementById('addMission').addEventListener('click', addMission);
document.getElementById('searchMissions').addEventListener('input', searchMissions);
document.getElementById('showCompletedMissions').addEventListener('change', toggleCompletedMissions);

// بستن پنل عملیاتی وقتی کاربر در هر جای دیگر صفحه کلیک کند
document.addEventListener('click', (e) => {
    if (!e.target.closest('.action-toggle') && !e.target.closest('.mission-actions')) {
        document.querySelectorAll('.mission-actions').forEach(panel => {
            panel.classList.remove('show-actions');
        });
    }
});

// بارگذاری اولیه
loadMissions();
renderMissions();

    </script>



<!-- Rating feature: robust wiring -->
<script>
// بازنویسی کامل بخش امتیازدهی — ذخیره در JSONBin و نمایش آمار ماهانه
(function(){
  // متغیرهای داخلی
  let ratingPD = new persianDate(); // برای ناوبری ماهیانه (شمسی)
  let ratingChartInstance = null;

  // دریافت رکورد کامل از JSONBin
  async function getBinRecord() {
    try {
      const res = await fetch(API_URL, { headers: { 'X-Master-Key': API_KEY } });
      if (!res.ok) throw new Error('خطا در دریافت داده از سرور');
      const json = await res.json();
      return json.record || {};
    } catch (e) {
      console.error('getBinRecord error', e);
      showNotification('خطا در دریافت داده‌ها از JSONBin', false, e.message);
      return {};
    }
  }

  // ذخیره رکورد کامل در JSONBin (PUT)
  async function putBinRecord(record) {
    try {
      const res = await fetch(API_URL, {
        method: 'PUT',
        headers: { 'X-Master-Key': API_KEY, 'Content-Type': 'application/json' },
        body: JSON.stringify(record)
      });
      if (!res.ok) throw new Error('خطا در ذخیره‌سازی در سرور');
      const j = await res.json();
      return j;
    } catch (e) {
      console.error('putBinRecord error', e);
      showNotification('خطا در ذخیره‌سازی در JSONBin', false, e.message);
      throw e;
    }
  }

  // رندر فرم امتیازدهی (فیلدهای عددی برای هر همکار)
async function renderRatingList() {
    const record = await getBinRecord();
    const members = record.teamMembers || (typeof teamMembers !== 'undefined' ? teamMembers : []);
    const ratings = record.ratings || [];
    const list = document.getElementById('ratingList');
    if (!list) return;
    list.innerHTML = '';

    // تاریخ انتخاب‌شده از input (میلادی)
    const dateInput = document.getElementById('ratingDate');
    const selectedDateISO = dateInput && dateInput.value ? dateInput.value : new Date().toISOString().slice(0,10);

    members.forEach((member, idx) => {
        const memberName = (typeof member === 'object') ? (member.name || member) : member;
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between border p-2 mb-2 rounded';
        
        const existing = ratings.find(r => r.member === memberName && r.date === selectedDateISO);
        
        // اگر امتیازی وجود ندارد یا امتیاز 0 است، فیلد را خالی بگذار
        const val = existing && existing.score !== 0 ? existing.score.toString() : '';
        const descVal = existing && existing.description ? existing.description : '';
        
        row.innerHTML = `
            <span style="flex:1">${memberName}</span>
            <input type="number" id="rating_score_${idx}" data-member-index="${idx}" 
                data-member-name="${memberName}" class="border p-1 w-20 ml-2" 
                min="-50" max="50" step="1" value="${val}" placeholder="امتیاز">
            <input type="text" id="rating_desc_${idx}" data-member-index="${idx}" 
                data-member-name="${memberName}" class="border p-1 w-40 ml-2" 
                value="${descVal}" placeholder="توضیح (اختیاری)">
        `;
        list.appendChild(row);
    });
}

  // ثبت یک‌جای تمام امتیازهای فرم برای تاریخ انتخاب‌شده
// در تابع saveAllRatings، این تغییرات را اعمال کنید:
// در تابع saveAllRatings، تغییرات زیر را اعمال کنید:
async function saveAllRatings() {
    const date = document.getElementById('ratingDate').value;
    if (!date) { 
        alert('لطفاً تاریخ را انتخاب کنید'); 
        return; 
    }

    const rec = await getBinRecord();
    const members = rec.teamMembers || (typeof teamMembers !== 'undefined' ? teamMembers : []);
    const isoDate = new Date(date).toISOString().slice(0,10);
    
    // بررسی اعتبار مقادیر
    let isValid = true;
    
    members.forEach((member, idx) => {
        const input = document.querySelector('#rating_score_' + idx);
        if (input) {
            const value = input.value.trim();
            
            if (value === '') {
                input.style.borderColor = '';
                return;
            }
            
            const score = parseInt(value, 10);
            
            if (isNaN(score) || score < -50 || score > 50) {
                isValid = false;
                input.style.borderColor = 'red';
            } else {
                input.style.borderColor = '';
            }
        }
    });

    if (!isValid) {
        alert('لطفاً مقادیر بین -50 تا 50 وارد کنید');
        return;
    }

    // حلقه ذخیره‌سازی با پشتیبانی از توضیحات
    members.forEach((member, idx) => {
        const memberName = (typeof member === 'object') ? (member.name || member) : member;
        const input = document.querySelector('#rating_score_' + idx);
        const descriptionInput = document.querySelector('#rating_desc_' + idx);
        
        if (!input) return;
        
        const value = input.value.trim();
        const description = descriptionInput ? descriptionInput.value.trim() : '';
        
        // اگر فیلد خالی است، از ذخیره‌سازی صرف نظر کن و رکورد موجود را حذف کن
        if (value === '') {
            const exIndex = rec.ratings.findIndex(r => r.member === memberName && r.date === isoDate);
            if (exIndex >= 0) {
                rec.ratings.splice(exIndex, 1);
            }
            return;
        }
        
        const score = parseInt(value,10);
        const exIndex = rec.ratings.findIndex(r => r.member === memberName && r.date === isoDate);
        
        if (exIndex >= 0) {
            rec.ratings[exIndex].score = score;
            rec.ratings[exIndex].description = description;
        } else {
            rec.ratings.push({ 
                member: memberName, 
                date: isoDate, 
                score, 
                description 
            });
        }
    });

    await putBinRecord(rec);
    ratings = rec.ratings;
    showNotification('تمام امتیازها و توضیحات ثبت شدند');
    renderRatingList();
    renderMonthlyAverages();
}

// تابع نمایش آمار ماهانه و نمودار
async function renderMonthlyAverages() {
    const rec = await getBinRecord();
    const ratings = rec.ratings || [];
    const members = rec.teamMembers || (typeof teamMembers !== 'undefined' ? teamMembers : []);

    // فیلتر امتیازات همان ماه شمسی (ratingPD)
    const filtered = ratings.filter(r => {
      try {
        const p = new persianDate(new Date(r.date));
        return p.month() === ratingPD.month() && p.year() === ratingPD.year();
      } catch (e) { return false; }
    });

    const averagesMap = {};
    const countMap = {};
    const totalScoresMap = {};
    const descriptionsMap = {}; // اضافه کردن برای ذخیره توضیحات
    
    members.forEach(m => {
      const name = (typeof m === 'object') ? (m.name || m) : m;
      averagesMap[name] = [];
      countMap[name] = 0;
      totalScoresMap[name] = 0;
      descriptionsMap[name] = []; // مقداردهی اولیه
    });
    
    filtered.forEach(r => {
      if (!averagesMap[r.member]) {
        averagesMap[r.member] = [];
        countMap[r.member] = 0;
        totalScoresMap[r.member] = 0;
        descriptionsMap[r.member] = [];
      }
      averagesMap[r.member].push(r.score);
      countMap[r.member]++;
      totalScoresMap[r.member] += r.score;
      
      // ذخیره توضیحات اگر وجود داشته باشد
      if (r.description) {
        descriptionsMap[r.member].push(r.description);
      }
    });

    // ایجاد متغیرهای labels و data برای نمودار (بر اساس مجموع امتیازات)
    const labels = [];
    const data = [];
    const backgroundColors = [];
    
    // مرتب سازی بر اساس مجموع امتیازات (نزولی)
    const sortedMembers = Object.keys(totalScoresMap).sort((a, b) => {
        return totalScoresMap[b] - totalScoresMap[a];
    });

    sortedMembers.forEach(member => {
      labels.push(member);
      const total = totalScoresMap[member] || 0;
      data.push(total);
      
      // تعیین رنگ بر اساس مثبت یا منفی بودن امتیاز
      if (total >= 0) {
        backgroundColors.push('#3b82f6'); // آبی برای امتیازات مثبت
      } else {
        backgroundColors.push('#ef4444'); // قرمز برای امتیازات منفی
      }
    });

    // ایجاد جدول
    const statsEl = document.getElementById('ratingsStats');
    if (!statsEl) return;

    // پاک کردن محتوای قبلی
    statsEl.innerHTML = '';

    // ایجاد عنوان جدول
    const title = document.createElement('h3');
    title.className = 'text-md font-bold mb-2 text-center';
    title.textContent = 'آمار امتیازات ماه ' + ratingPD.format('MMMM YYYY');
    statsEl.appendChild(title);

    // ایجاد جدول
    const table = document.createElement('table');
    table.className = 'w-full border-collapse border border-gray-300 bg-white text-sm';

    // ایجاد هدر جدول با ستون جدید برای توضیحات
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr class="bg-gray-100">
            <th class="border border-gray-300 p-2 text-center">ردیف</th>
            <th class="border border-gray-300 p-2 text-center">نام همکار</th>
            <th class="border border-gray-300 p-2 text-center">جمع امتیازات</th>
            <th class="border border-gray-300 p-2 text-center">تعداد امتیازات</th>
            <th class="border border-gray-300 p-2 text-center">توضیحات</th>
        </tr>
    `;
    table.appendChild(thead);

    // ایجاد بدنه جدول
    const tbody = document.createElement('tbody');
    
    // پر کردن ردیف‌های جدول
    sortedMembers.forEach((member, index) => {
        const scores = averagesMap[member] || [];
        const count = countMap[member] || 0;
        const total = totalScoresMap[member] || 0;
        const avg = scores.length > 0 ? 
            (scores.reduce((sum, score) => sum + score, 0) / scores.length).toFixed(2) : '0.00';
        
        // ایجاد لیست توضیحات
        const descriptions = descriptionsMap[member] || [];
        const descriptionsHtml = descriptions.length > 0 ? 
            `<ul class="text-right text-xs">${descriptions.map(desc => `<li>${desc}</li>`).join('')}</ul>` : 
            '---';

        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
        row.innerHTML = `
            <td class="border border-gray-300 p-2 text-center">${index + 1}</td>
            <td class="border border-gray-300 p-2 text-center">${member}</td>
<td class="border border-gray-300 p-2 text-center">${total}</td>
            <td class="border border-gray-300 p-2 text-center">${count}</td>
            <td class="border border-gray-300 p-2 text-center">${descriptionsHtml}</td>
        `;
        tbody.appendChild(row);
    });

    table.appendChild(tbody);
    statsEl.appendChild(table);

    // نمایش بهترین همکار ماه بر اساس مجموع امتیازات
    if (sortedMembers.length > 0) {
        const bestMember = sortedMembers[0];
        const bestScore = totalScoresMap[bestMember];
        
        const bestMemberEl = document.createElement('div');
        bestMemberEl.className = 'mt-4 p-3 bg-green-100 border border-green-300 rounded text-center';
        bestMemberEl.innerHTML = '<strong>بهترین همکار ماه (بر اساس مجموع امتیازات):</strong> ' + bestMember + ' با مجموع امتیاز ' + bestScore;
        statsEl.appendChild(bestMemberEl);
    }

    // رسم نمودار بر اساس مجموع امتیازات
    const canvas = document.getElementById('ratingChart');
    if (!canvas) return;
    canvas.classList.remove('hidden');
    const ctx = canvas.getContext('2d');
    if (ratingChartInstance) {
      try { ratingChartInstance.destroy(); } catch(e) { console.warn(e); }
    }
    
    // تعیین محدوده محور Y
    const minValue = Math.min(...data);
    const maxValue = Math.max(...data);
    
    ratingChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'مجموع امتیازات',
          data: data,
          backgroundColor: backgroundColors
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            suggestedMin: minValue < 0 ? minValue - 5 : 0,
            suggestedMax: maxValue > 0 ? maxValue + 5 : 10
          }
        }
      }
    });
}

// اضافه کردن توابع مدیریت دکمه‌های روز قبل و بعد
function goToPrevRatingDay() {
    const currentDate = new Date(document.getElementById('ratingDate').value);
    if (isNaN(currentDate.getTime())) {
        // اگر تاریخ معتبر نیست، از امروز شروع کن
        currentDate = new Date();
    }
    currentDate.setDate(currentDate.getDate() - 1);
    document.getElementById('ratingDate').value = currentDate.toISOString().slice(0, 10);
    updateSelectedDateLabel();
    renderRatingList();
}

function goToNextRatingDay() {
    const currentDate = new Date(document.getElementById('ratingDate').value);
    if (isNaN(currentDate.getTime())) {
        // اگر تاریخ معتبر نیست، از امروز شروع کن
        currentDate = new Date();
    }
    currentDate.setDate(currentDate.getDate() + 1);
    document.getElementById('ratingDate').value = currentDate.toISOString().slice(0, 10);
    updateSelectedDateLabel();
    renderRatingList();
}

function updateSelectedDateLabel() {
    const dateInput = document.getElementById('ratingDate');
    if (dateInput && dateInput.value) {
        const g = new Date(dateInput.value);
        const pdate = new persianDate(g);
        const sel = document.getElementById('selectedDateLabel');
        if (sel) sel.innerText = 'تاریخ انتخاب‌شده (شمسی): ' + pdate.format('YYYY/MM/DD');
    }
}




  function showOnlyRatingSection() {
    const section = document.getElementById('ratingSection');
    if (!section) return;
    const parent = section.parentElement;
    if (parent) {
      const siblings = parent.querySelectorAll(':scope > *');
      siblings.forEach(el => {
        if (el !== section && el.classList) el.classList.add('hidden');
        if (el === section) el.classList.remove('hidden');
      });
    }
    section.classList.remove('hidden');
    // رندر فرم و آمار
    renderRatingList();
    renderMonthlyAverages();
  }

  // event bindings


  document.addEventListener('DOMContentLoaded', function(){
    try {
      const toggle = document.getElementById('ratingToggle');
      if (toggle) {
        toggle.addEventListener('click', function(){
          const section = document.getElementById('ratingSection');
          if (!section) return;
          if (section.classList.contains('hidden')) {
            showOnlyRatingSection();
          } else {
            const parent = section.parentElement;
            if (parent) {
              parent.querySelectorAll(':scope > *').forEach(el => el.classList.remove('hidden'));
            }
            section.classList.add('hidden');
          }
        });
      }

 const prevRatingDayBtn = document.getElementById('prevRatingDay');
      const nextRatingDayBtn = document.getElementById('nextRatingDay');
      
      if (prevRatingDayBtn) {
        prevRatingDayBtn.addEventListener('click', goToPrevRatingDay);
      }
      
      if (nextRatingDayBtn) {
        nextRatingDayBtn.addEventListener('click', goToNextRatingDay);
      }

      const closeRatingBtn = document.getElementById('closeRatingSection');
      if (closeRatingBtn) {
        closeRatingBtn.addEventListener('click', function() {
          const section = document.getElementById('ratingSection');
          const parent = section.parentElement;
          
          if (parent) {
            parent.querySelectorAll(':scope > *').forEach(el => el.classList.remove('hidden'));
          }
          section.classList.add('hidden');
        });
      }

      // تاریخ امروز پیش‌فرض
      const dateInput = document.getElementById('ratingDate');
      if (dateInput) {
        const todayISO = new Date().toISOString().slice(0,10);
        dateInput.value = todayISO;
        const p = new persianDate(new Date(todayISO));
        const selEl = document.getElementById('selectedDateLabel');
        if (selEl) selEl.innerText = 'تاریخ انتخاب‌شده (شمسی): ' + p.format('YYYY/MM/DD');
        dateInput.addEventListener('change', (e)=>{
          const g = new Date(e.target.value);
          const pdate = new persianDate(g);
          const sel = document.getElementById('selectedDateLabel');
          if (sel) sel.innerText = 'تاریخ انتخاب‌شده (شمسی): ' + pdate.format('YYYY/MM/DD');
          renderRatingList();
        });
      }

      // دکمه‌ها
      const saveAllBtn = document.getElementById('saveAllRatings');
      if (saveAllBtn) saveAllBtn.addEventListener('click', saveAllRatings);
      const prevBtn = document.getElementById('prevRatingMonth');
      const nextBtn = document.getElementById('nextRatingMonth');
      const showAvgBtn = document.getElementById('showMonthlyAverages');
      if (prevBtn) prevBtn.addEventListener('click', ()=>{ ratingPD = ratingPD.subtract('months',1); renderMonthlyAverages(); });
      if (nextBtn) nextBtn.addEventListener('click', ()=>{ ratingPD = ratingPD.add('months',1); renderMonthlyAverages(); });
      if (showAvgBtn) showAvgBtn.addEventListener('click', renderMonthlyAverages);
    } catch (e) {
      console.error('Rating init error', e);
    }
  });

})(); 
</script>
<!-- End Rating feature -->


<script>
// Initialize Persian datepicker for ratingDate and highlight rated dates
(function(){
  function getRatedDatesFromGlobalOrLocal() {
    try {
      if (typeof ratings !== 'undefined' && Array.isArray(ratings)) {
        return ratings.map(r => r.date).filter(Boolean);
      }
    } catch(e){}
    try {
      const rs = JSON.parse(localStorage.getItem('ratings') || '[]');
      if (Array.isArray(rs)) return rs.map(r => r.date).filter(Boolean);
    } catch(e){}
    return [];
  }

  const ratedDates = getRatedDatesFromGlobalOrLocal();

  // ensure jQuery and persianDatepicker are available
  if (typeof $ === 'undefined' || typeof $.fn.persianDatepicker === 'undefined') {
    console.warn('jQuery or persianDatepicker not available yet. Retrying in 200ms...');
    setTimeout(function(){ /* try again */ initPersianPicker(); }, 200);
  } else {
    initPersianPicker();
  }

  function initPersianPicker(){
    try{
      $('#ratingDate').persianDatepicker({
        format: 'YYYY/MM/DD',
        autoClose: true,
        observer: true,
        toolbox: { calendarSwitch: { enabled: false } },
        altField: '#ratingDate', // keep the same field
        checkDate: function(unix){
          try{
            const pd = new persianDate(unix);
            const dateStr = pd.format('YYYY-MM-DD');
            if (ratedDates.indexOf(dateStr) !== -1) {
              return { selectable: true, style: 'selected-holiday' };
            }
          } catch(e){}
          return true;
        },
        onSelect: function(unix){
          try{
            const pd = new persianDate(unix);
            const greg = pd.toCalendar('gregorian').format('YYYY-MM-DD');
            document.getElementById('selectedDateLabel').textContent = 'تاریخ انتخاب شده (میلادی): ' + greg;
            // store the selected gregorian date into a data attribute for later saving if needed
            document.getElementById('ratingDate').dataset.gregorian = greg;
          } catch(e){ console.warn(e); }
        }
      });
    } catch(e){
      console.error('خطا در مقداردهی تقویم شمسی:', e);
    }
  }
})();
</script>
<style>
/* Highlight style used by persian-datepicker via checkDate style property */
.selected-holiday .datepicker--cell-day {
  background-color: #fde68a !important;
  color: #111827 !important;
  border-radius: 6px;
}
/* Also add a small badge when the input has rated date */
</style>


<!-- Rating Password Modal -->
<div id="ratingPasswordModal" style="display:none; position:fixed; z-index:10000; inset:0; background:rgba(0,0,0,0.7); align-items:center; justify-content:center;">
  <div style="background:white; padding:1.5rem; border-radius:0.5rem; width:90%; max-width:400px;">
    <h3 class="text-lg font-bold mb-2">رمز عبور برای نمایش SCORE</h3>
    <input type="password" id="ratingPasswordInput" class="password-input" placeholder="رمز عبور">
    <div id="ratingPasswordError" class="text-red-500 text-sm mt-2 hidden">رمز عبور اشتباه است</div>
    <div class="flex gap-2 mt-4">
      <button id="ratingPasswordOk" class="btn btn-primary flex-1">تایید</button>
      <button id="ratingPasswordCancel" class="btn btn-danger flex-1">لغو</button>
    </div>
  </div>
</div>
<script>
// Toggle نمایش/مخفی یادداشت روز با کلیک روی عنوان
(function(){
    const noteHeader = document.querySelector('.note-container h3');
    const noteContent = document.getElementById('noteContent');
    if (noteHeader && noteContent) {
        noteContent.classList.add('hidden'); // کل محتوا (شامل فیلد و دکمه و متن) مخفی
        noteHeader.style.cursor = 'pointer';
        noteHeader.title = 'برای نمایش/مخفی کردن یادداشت کلیک کنید';
        noteHeader.addEventListener('click', (e) => {
            noteContent.classList.toggle('hidden');
        });
    }
})();


// Require password before opening ratingSection (SCORE)
(function(){
    const scoreBtn = document.getElementById('ratingToggle');
    const ratingModal = document.getElementById('ratingPasswordModal');
    const okBtn = document.getElementById('ratingPasswordOk');
    const cancelBtn = document.getElementById('ratingPasswordCancel');
    const input = document.getElementById('ratingPasswordInput');
    const err = document.getElementById('ratingPasswordError');
    const ratingSection = document.getElementById('ratingSection');

    if (!scoreBtn || !ratingModal || !ratingSection) return;

    // همیشه در شروع ratingSection مخفی باشد
    ratingSection.classList.add('hidden');

    scoreBtn.addEventListener('click', (e) => {
        err.classList.add('hidden');
        input.value = '';
        ratingModal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // جلوگیری از اسکرول
    });

    cancelBtn.addEventListener('click', () => {
        ratingModal.style.display = 'none';
        document.body.style.overflow = ''; // بازگرداندن اسکرول
    });

    okBtn.addEventListener('click', () => {
        const val = input.value;
        if (val === appPassword) {
            ratingModal.style.display = 'none';
            document.body.style.overflow = ''; 
            ratingSection.classList.remove('hidden');
        } else {
            err.classList.remove('hidden');
            err.textContent = 'رمز عبور اشتباه است';
        }
    });

    input.addEventListener('keypress', (ev) => {
        if (ev.key === 'Enter') okBtn.click();
    });

    const closeRating = document.getElementById('closeRatingSection');
    if (closeRating) {
        closeRating.addEventListener('click', () => {
            ratingSection.classList.add('hidden');
        });
    }
})();
</script>
</body>
</html>
